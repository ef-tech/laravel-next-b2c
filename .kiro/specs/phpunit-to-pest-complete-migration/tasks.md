# 実装計画

## タスク概要

本実装計画は、Laravel 12アプリケーションの既存PHPUnitテストスイート（20ファイル、90+テストケース）をPest 4テストフレームワークに完全移行するための段階的なタスクを定義します。4つのフェーズ（準備、変換、検証、クリーンアップ）に分割し、各タスクは1-3時間で完了可能な粒度に設計されています。

## 実装タスク

- [x] 1. 移行準備と既存テスト状態の確認
  - 既存のPHPUnitテストファイルをすべてリストアップし、変換対象を特定する
  - 変換対象20ファイルの詳細情報（テスト数、使用機能、依存関係）を記録する
  - 既存のPHPUnitテストスイートを実行し、すべてグリーン状態であることを確認する
  - 変換スクリプトの動作確認を実施し、バックアップ機能が正常動作することを検証する
  - gitignoreに`.bak`ファイルを追加し、バックアップファイルがコミットされないようにする
  - _要件: 1.1, 3.1, 3.2, 4.2_

- [x] 2. Featureテストの自動変換とバックアップ生成
  - 19個のFeatureテストファイルに対して変換スクリプトを一括実行する
  - 各ファイルのバックアップが正常に作成されていることを確認する
  - 変換スクリプトによる基本構文変換の成功を確認する（namespace削除、クラス定義削除、test_メソッド変換）
  - 変換ログを記録し、エラーが発生したファイルを特定する
  - _要件: 1.1, 1.2, 1.4, 4.1, 4.2_

- [x] 3. Unitテストの自動変換とバックアップ生成
  - 1個のUnitテストファイルに対して変換スクリプトを実行する
  - バックアップファイルが正常に作成されていることを確認する
  - 変換スクリプトによる基本構文変換の成功を確認する
  - _要件: 1.1, 1.2, 1.4, 4.1, 4.2_

- [x] 4. Featureテストの手動精緻化（Batch 1: 最初の5ファイル）
- [x] 4.1 アサーション構文のPest形式への変換
  - PHPUnitアサーション（`$this->assert*`）をPestの`expect()`構文に変換する
  - 複雑なアサーションチェーンをPestの流暢なAPIに変換する
  - Laravelテストヘルパー（`$this->get()`, `$this->postJson()`等）はそのまま維持する
  - setUp/tearDownメソッドをbeforeEach/afterEach関数に変換する（存在する場合）
  - _要件: 1.3, 1.5, 2.2_

- [x] 4.2 ファイル単位でのテスト実行と検証
  - 変換した5ファイルそれぞれに対してPestテストを個別実行する
  - すべてのテストケースがグリーン状態であることを確認する
  - エラーが発生した場合、バックアップから復元し再変換する
  - 変換パターンと注意点を記録する
  - _要件: 2.1, 2.2_

- [x] 5. Featureテストの手動精緻化（Batch 2: 次の5ファイル）
- [x] 5.1 アサーション構文のPest形式への変換
  - PHPUnitアサーション（`$this->assert*`）をPestの`expect()`構文に変換する
  - 複雑なアサーションチェーンをPestの流暢なAPIに変換する
  - Laravelテストヘルパー（`$this->get()`, `$this->postJson()`等）はそのまま維持する
  - setUp/tearDownメソッドをbeforeEach/afterEach関数に変換する（存在する場合）
  - _要件: 1.3, 1.5, 2.2_

- [x] 5.2 ファイル単位でのテスト実行と検証
  - 変換した5ファイルそれぞれに対してPestテストを個別実行する
  - すべてのテストケースがグリーン状態であることを確認する
  - エラーが発生した場合、バックアップから復元し再変換する
  - _要件: 2.1, 2.2_

- [x] 6. Featureテストの手動精緻化（Batch 3: 次の5ファイル）
- [x] 6.1 アサーション構文のPest形式への変換
  - PHPUnitアサーション（`$this->assert*`）をPestの`expect()`構文に変換する
  - 複雑なアサーションチェーンをPestの流暢なAPIに変換する
  - Laravelテストヘルパー（`$this->get()`, `$this->postJson()`等）はそのまま維持する
  - setUp/tearDownメソッドをbeforeEach/afterEach関数に変換する（存在する場合）
  - _要件: 1.3, 1.5, 2.2_

- [x] 6.2 ファイル単位でのテスト実行と検証
  - 変換した5ファイルそれぞれに対してPestテストを個別実行する
  - すべてのテストケースがグリーン状態であることを確認する
  - エラーが発生した場合、バックアップから復元し再変換する
  - _要件: 2.1, 2.2_

- [x] 7. Featureテストの手動精緻化（Batch 4: 残り4ファイル）
- [x] 7.1 アサーション構文のPest形式への変換
  - PHPUnitアサーション（`$this->assert*`）をPestの`expect()`構文に変換する
  - 複雑なアサーションチェーンをPestの流暢なAPIに変換する
  - Laravelテストヘルパー（`$this->get()`, `$this->postJson()`等）はそのまま維持する
  - setUp/tearDownメソッドをbeforeEach/afterEach関数に変換する（存在する場合）
  - _要件: 1.3, 1.5, 2.2_

- [x] 7.2 ファイル単位でのテスト実行と検証
  - 変換した4ファイルそれぞれに対してPestテストを個別実行する
  - すべてのテストケースがグリーン状態であることを確認する
  - エラーが発生した場合、バックアップから復元し再変換する
  - _要件: 2.1, 2.2_

- [x] 8. Unitテストの手動精緻化
- [x] 8.1 アサーション構文のPest形式への変換
  - PHPUnitアサーション（`$this->assert*`）をPestの`expect()`構文に変換する
  - シンプルなUnitテストのため、基本的なアサーション変換のみ実施する
  - _要件: 1.3, 2.2_

- [x] 8.2 ファイル単位でのテスト実行と検証
  - 変換したUnitテストファイルに対してPestテストを個別実行する
  - すべてのテストケースがグリーン状態であることを確認する
  - _要件: 2.1, 2.2_

- [x] 9. データベーステストとSanctum認証テストの検証
  - RefreshDatabaseトレイトが使用されているテストファイルを確認する
  - Pest.php設定の`uses(RefreshDatabase::class)->in('Feature')`が適用されていることを検証する
  - Sanctum認証を使用しているテストファイルで`actingAsApi()`ヘルパーが正常動作することを確認する
  - カスタム期待値（`toBeJsonOk()`, `toHaveCors()`）を使用しているテストの動作を確認する
  - _要件: 2.3, 2.4, 2.5_

- [x] 10. 全Pestテストスイートの統合実行と検証
  - composer testコマンドを実行し、90+テストケースすべてが成功することを確認する
  - テスト実行結果（実行時間、アサーション数）を記録する
  - 既存のPest形式テスト（Api、Architecture）も含めて全27ファイルが正常動作することを確認する
  - エラーが発生した場合、該当ファイルを特定し修正する
  - _要件: 2.1, 3.5, 6.1_

- [x] 11. コード品質チェックの実行と検証
- [x] 11.1 Larastan静的解析の実行
  - composer stanコマンドを実行し、Pestテストファイルに対してLevel 8品質基準を満たすことを確認する
  - 静的解析エラーが発生した場合、型定義や構文を修正する
  - _要件: 6.2_

- [x] 11.2 Laravel Pintフォーマットの実行
  - composer pintコマンドを実行し、PestテストファイルがLaravel規約に準拠していることを確認する
  - フォーマット違反が検出された場合、自動修正を適用する
  - _要件: 6.3_

- [x] 12. パフォーマンステストの実行と検証
- [x] 12.1 並列テスト実行の検証
  - composer test-parallelコマンドを実行し、全テストが成功することを確認する
  - 並列実行による実行時間短縮効果を測定する（目標: 50%以上短縮）
  - _要件: 6.4_

- [x] 12.2 テストシャーディングの検証
  - composer test-shardコマンドを実行し、割り当てシャードのテストが成功することを確認する
  - シャーディング設定が正常動作することを検証する
  - _要件: 6.5_

- [x] 12.3 カバレッジ生成の検証
  - composer test-coverageコマンドを実行し、カバレッジレポートが生成されることを確認する
  - カバレッジが80%以上であることを確認する
  - _要件: 5.5_

- [x] 13. PHPUnit設定ファイルとComposerコマンドの削除
  - phpunit.xmlファイルを削除する
  - composer.jsonからtest-phpunitスクリプトを削除する
  - composer.jsonからtest-allスクリプトを削除する（testコマンドに統合済みのため）
  - 削除後、composer testコマンドが正常動作することを確認する
  - _要件: 7.2, 7.3_

- [x] 14. TestCaseファイルの確認と更新（必要に応じて）
  - tests/TestCase.phpファイルを確認し、PHPUnit専用の実装が含まれていないことを検証する
  - Pest互換形式への更新が必要な場合、適切に修正する（現状ではLaravel標準形式のため変更不要と想定）
  - _要件: 7.4_

- [x] 15. ドキュメントの更新
  - README.mdのテスト実行コマンドをPest形式に更新する（composer test、composer test-coverage等）
  - PHPUnit関連の記載をすべて削除する
  - Pest実行方法と利用可能なコマンドを明記する
  - _要件: 7.5_

- [x] 16. バックアップファイルの削除とクリーンアップ
  - すべての.bakファイルを削除する（find tests -name "*.bak" -delete）
  - .gitignoreから.bak記載を削除する（不要になったため）
  - 最終的なディレクトリ構造を確認し、不要なファイルが残っていないことを検証する
  - _要件: 7.1_

- [x] 17. 最終検証と移行完了確認
  - composer testを実行し、全テストが成功することを最終確認する
  - composer qualityを実行し、Larastan Level 8とPintが成功することを確認する
  - CI/CD設定（.github/workflows/test.yml）がPestテストを正常実行することを確認する
  - 移行完了レポートを作成し、変換結果と検証結果を記録する
  - _要件: 5.4, 6.1, 6.2, 6.3_

## タスク完了基準

各タスクの完了基準は以下の通りです：

- **タスク1**: 20ファイルのリスト作成完了、既存テストすべてグリーン、.gitignoreに.bak追加完了
- **タスク2**: 19個のFeatureテストファイル自動変換完了、バックアップファイル19個生成完了
- **タスク3**: 1個のUnitテストファイル自動変換完了、バックアップファイル1個生成完了
- **タスク4-8**: 各Batchのファイル単位テスト実行すべて成功、変換パターン記録完了
- **タスク9**: RefreshDatabase/Sanctum/カスタム期待値テストすべて正常動作確認
- **タスク10**: composer test実行で90+テストケースすべて成功（0 failures）
- **タスク11**: composer stan成功、composer pint成功
- **タスク12**: 並列/シャーディング/カバレッジテストすべて成功
- **タスク13**: phpunit.xml削除完了、test-phpunit/test-allコマンド削除完了、composer test正常動作
- **タスク14**: tests/TestCase.phpのPest互換性確認完了
- **タスク15**: README.md更新完了、Pest実行方法記載完了
- **タスク16**: .bakファイル全削除完了、クリーンなディレクトリ構造確認
- **タスク17**: 最終検証すべて成功、移行完了レポート作成完了

## 推定所要時間

- **フェーズ1（準備）**: タスク1 - 1時間
- **フェーズ2（変換）**: タスク2-8 - 4-5時間
- **フェーズ3（検証）**: タスク9-12 - 2-3時間
- **フェーズ4（クリーンアップ）**: タスク13-17 - 1-2時間

**合計推定時間**: 8-11時間

## 注意事項

- 各タスクは順次実行し、前のタスクが完了してから次のタスクに進むこと
- エラーが発生した場合、バックアップファイルから復元し、再変換を実施すること
- 変換パターンと注意点を記録し、後続のBatchで活用すること
- 並列実行時の競合状態に注意し、テストが失敗する場合は原因を特定すること