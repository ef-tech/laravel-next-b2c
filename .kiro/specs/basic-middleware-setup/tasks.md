# 実装計画

## 概要

Laravel Next.js B2C Application TemplateのAPI専用Laravel 12バックエンドに、統一ミドルウェアスタックを確立します。既存のSanctum認証、セキュリティヘッダー（CSP、CORS）、DDD/クリーンアーキテクチャとシームレスに統合し、12種類のミドルウェアと6種類のミドルウェアグループにより、セキュリティ、パフォーマンス、可観測性を包括的に向上させます。

## 実装タスク

- [x] 1. Application層ポート設計とインターフェース定義
- [x] 1.1 AuthorizationServiceポートを定義する
  - Application層に認可サービスのインターフェースを作成する
  - ユーザーと権限文字列を受け取り、認可判定結果を返すメソッドを定義する
  - DDD/クリーンアーキテクチャ原則に従い、Domain層に依存しないインターフェースとする
  - PHPStan Level 8準拠の型定義を含める
  - _Requirements: 5.2, 5.3, 5.7, 15.3_

- [x] 1.2 AuditServiceポートを定義する
  - Application層に監査サービスのインターフェースを作成する
  - 監査イベント情報を受け取り、記録処理を実行するメソッドを定義する
  - DDD/クリーンアーキテクチャ原則に従い、Domain層に依存しないインターフェースとする
  - PHPStan Level 8準拠の型定義を含める
  - _Requirements: 6.3, 15.4_

- [x] 1.3 Application層ポートのInfrastructure実装を作成する
  - AuthorizationServiceの具象実装をInfrastructure層に作成する
  - AuditServiceの具象実装をInfrastructure層に作成する
  - Eloquent/データベースを使用した実際の認可判定ロジックを実装する
  - 監査ログをデータベースに記録するロジックを実装する
  - Laravelサービスプロバイダーで依存性注入設定を行う
  - _Requirements: 5.2, 6.3, 15.2_

- [x] 2. 環境設定と設定ファイル整備
- [x] 2.1 ミドルウェア共通設定ファイルを作成する
  - ミドルウェア全体の共通設定を管理する設定ファイルを作成する
  - 環境変数から設定値を読み込む構造を定義する
  - ログチャンネル設定、機密データマスキングパターンを含める
  - 開発環境と本番環境で異なる設定を適用できるようにする
  - _Requirements: 13.5_

- [x] 2.2 レート制限設定ファイルを作成する
  - エンドポイントごとの動的レート制限設定を管理する設定ファイルを作成する
  - ログイン、認証済みAPI、公開APIなど、エンドポイントタイプ別の制限値を定義する
  - レート制限識別子（IP、ユーザーID、トークン）の設定を含める
  - 環境変数からレート制限値を読み込めるようにする
  - _Requirements: 3.2, 3.7, 3.8, 3.9, 3.11, 13.2_

- [x] 2.3 パフォーマンス監視設定ファイルを作成する
  - パフォーマンスメトリクス収集の設定を管理する設定ファイルを作成する
  - レスポンス時間閾値、パーセンタイル設定を定義する
  - アラート条件とログチャンネル設定を含める
  - 環境別のメトリクス収集レベルを設定可能にする
  - _Requirements: 2.6, 2.7, 13.4_

- [x] 2.4 環境変数テンプレートを更新する
  - 新規追加する環境変数を環境変数テンプレートに記載する
  - レート制限、キャッシュヘッダー、パフォーマンス監視の設定項目を追加する
  - 各環境変数にコメントで説明を追加する
  - 開発環境と本番環境の推奨設定値を記載する
  - _Requirements: 13.6_

- [x] 3. リクエストトレーシングとログ記録機能の実装
- [x] 3.1 リクエストID生成機能を実装する
  - 全てのAPIリクエストに一意なIDを付与する機能を実装する
  - 既にヘッダーでリクエストIDが提供されている場合は継承する
  - リクエストIDをリクエストとレスポンスの両方のヘッダーに設定する
  - UUIDv4形式のIDを生成する
  - _Requirements: 1.1, 1.2, 1.3_

- [x] 3.2 分散トレーシング対応機能を実装する
  - Correlation IDヘッダーを処理し、分散システム全体でリクエストを追跡可能にする
  - 既にヘッダーでCorrelation IDが提供されている場合は継承する
  - W3C Trace Context仕様のtracepar entヘッダーを処理する
  - トレースコンテキストをログコンテキストに追加する
  - _Requirements: 1.4, 1.5, 1.6, 1.7_

- [x] 3.3 構造化リクエストロギング機能を実装する
  - 全てのAPIリクエストの詳細情報をJSON構造化ログとして記録する
  - リクエストID、Correlation ID、ユーザーID、メソッド、URL、ステータス、処理時間、IPアドレスを記録する
  - 機密データ（パスワード、トークン）を自動的にマスキングする
  - 非同期でログ出力を実行し、レスポンス時間への影響を最小化する（terminateメソッド使用）
  - 専用ログチャンネルに出力し、30日間のログ保持期間後に自動削除する
  - _Requirements: 1.8, 1.9, 1.10, 1.11, 1.12_

- [x] 4. パフォーマンスメトリクス収集機能の実装
- [x] 4.1 パフォーマンス測定機能を実装する
  - APIリクエストのレスポンス時間をマイクロ秒精度で測定する
  - ピークメモリ使用量を記録する
  - データベースクエリ実行回数をカウントする
  - 専用ログチャンネルに出力する
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5_

- [x] 4.2 パフォーマンスアラート機能を実装する
  - レスポンス時間が設定された閾値を超過した場合にアラートログを記録する
  - パーセンタイル値計算を可能にする形式でメトリクスを記録する
  - 非同期でメトリクス収集処理を実行し、レスポンス時間への影響を5ms未満に抑える
  - _Requirements: 2.6, 2.7, 2.8_

- [x] 5. 動的レート制限とAPI保護機能の実装
- [x] 5.1 Redis統合レート制限基盤を実装する
  - Redisを使用した動的レート制限機能を実装する
  - エンドポイントごとに異なる制限値（リクエスト数/分）を設定可能にする
  - レート制限キーを生成する（形式: rate_limit:{endpoint}:{identifier}）
  - レート制限識別子（IP、ユーザーID、トークン、パス）を決定するロジックを実装する
  - _Requirements: 3.1, 3.2, 3.3, 3.4_

- [x] 5.2 レート制限ヘッダーとエラーハンドリングを実装する
  - レート制限レスポンスヘッダーを設定する（X-RateLimit-Limit、X-RateLimit-Remaining、X-RateLimit-Reset）
  - レート制限超過時にHTTP 429ステータスコードを返す
  - エンドポイントタイプ別のレート制限を適用する（ログイン: 5/分、認証済み: 1000/分、公開: 100/分）
  - _Requirements: 3.5, 3.6, 3.7, 3.8, 3.9_

- [x] 5.3 レート制限のグレースフルデグラデーションを実装する
  - Redisサービスがダウンしている場合にレート制限をスキップし、サービス継続性を優先する
  - 環境変数または設定ファイルで動的設定を可能にする
  - _Requirements: 3.10, 3.11_

- [ ] 6. Sanctumトークン詳細検証と認証強化機能の実装
- [ ] 6.1 トークン有効期限検証機能を実装する
  - Laravel Sanctumトークンの有効期限を検証する
  - トークンが有効期限切れの場合はHTTP 401ステータスコードを返す
  - 有効なトークンでアクセスした場合はトークンの最終使用時刻を更新する
  - _Requirements: 4.1, 4.2, 4.3_

- [ ] 6.2 トークンAbilities検証とエラーロギングを実装する
  - トークンAbilities（権限）が設定されている場合に検証する準備をする
  - トークン検証失敗時に詳細なエラーログを記録する（有効期限切れ、権限不足、無効トークン等）
  - 既存のauth:sanctumミドルウェアと併用できるように追加の詳細検証として動作する
  - データベース負荷を最小化するため、バッチ更新を使用する
  - _Requirements: 4.4, 4.5, 4.6, 4.7_

- [ ] 7. 権限ベースアクセス制御機能の実装
- [ ] 7.1 権限検証機能を実装する
  - 認証済みユーザーが権限必須エンドポイントにアクセスする際に権限を検証する
  - Application層のAuthorizationServiceポートを経由して権限判定を行う
  - ユーザーが必要な権限を持たない場合はHTTP 403ステータスコードを返す
  - 権限検証に成功した場合はリクエスト処理を継続する
  - _Requirements: 5.1, 5.2, 5.3, 5.4_

- [ ] 7.2 権限検証ロギングとSanctum Abilities統合を実装する
  - 管理者限定エンドポイントにアクセスする際に管理者権限の保有を検証する
  - 権限検証結果をログに記録する（ユーザーID、エンドポイント、要求権限、検証結果）
  - Sanctum Abilitiesと統合し、トークンに付与された権限を検証可能にする
  - _Requirements: 5.5, 5.6, 5.7_

- [ ] 8. 監査証跡と重要操作の記録機能の実装
- [ ] 8.1 監査イベント記録機能を実装する
  - 認証済みユーザーがデータ変更操作を実行した際に監査イベントを記録する
  - 監査イベントに必要なフィールドを含める（ユーザーID、アクション、リソース、変更内容、IPアドレス、タイムスタンプ）
  - Application層のAuditServiceポートを経由してイベントを発火する
  - 非同期で監査ログを記録し、レスポンス時間への影響を最小化する（terminateメソッド使用）
  - _Requirements: 6.1, 6.2, 6.3, 6.4_

- [ ] 8.2 監査ログの差分記録とプライバシー保護を実装する
  - 変更前後の差分を記録する
  - 機密データをマスキングし、プライバシーを保護する
  - GETリクエスト（読み取り専用操作）では監査イベントを記録しない
  - _Requirements: 6.5, 6.6, 6.7_

- [ ] 9. Idempotency保証と重複防止機能の実装
- [ ] 9.1 Idempotencyキー検証基盤を実装する
  - Idempotency-Keyヘッダーによる冪等性保証機能を実装する
  - IdempotencyキーをRedisに保存する（形式: idempotency:{key}:{user_id}）
  - 同じIdempotencyキーで2回目のリクエストを受信した際にリクエストペイロードの指紋を比較する
  - _Requirements: 7.1, 7.2, 7.3_

- [ ] 9.2 Idempotencyキャッシュとエラーハンドリングを実装する
  - ペイロード指紋が一致する場合はキャッシュ済みレスポンスを返却し、処理を実行しない
  - ペイロード指紋が異なる場合はHTTP 422ステータスコードを返し、リクエストを拒否する
  - IdempotencyキーのTTL（有効期限）を24時間に設定する
  - 24時間経過後に同じキーでリクエストを受信した場合は新規リクエストとして処理する
  - Webhookエンドポイントに対してIdempotency検証を必須とする
  - _Requirements: 7.4, 7.5, 7.6, 7.7, 7.8_

- [ ] 10. キャッシュ制御とHTTPキャッシング最適化機能の実装
- [ ] 10.1 Cache-Controlヘッダー設定機能を実装する
  - GETリクエストに対してCache-Controlヘッダーを設定する
  - 開発環境ではno-cacheを設定し、本番環境ではエンドポイントごとのmax-age値を設定する
  - キャッシュTTLをエンドポイントごとに設定する（例: /api/health: 60秒、/api/user: 300秒）
  - _Requirements: 8.1, 8.2, 8.3, 8.4_

- [ ] 10.2 Expiresヘッダーと環境変数制御を実装する
  - Cache-Controlヘッダーと併せてExpiresヘッダーも設定する
  - 環境変数で機能の有効/無効を切り替え可能にする
  - POST/PUT/PATCH/DELETEリクエストに対してはキャッシュヘッダーを設定しない
  - _Requirements: 8.5, 8.6, 8.7_

- [ ] 11. ETagによる条件付きGETサポート機能の実装
- [ ] 11.1 ETag生成機能を実装する
  - GETリクエストのレスポンスからETagを生成する（レスポンスボディサイズが1MB未満の場合）
  - レスポンスボディからSHA256ハッシュを生成し、ETagヘッダーをレスポンスに設定する
  - _Requirements: 9.1, 9.2_

- [ ] 11.2 条件付きGETリクエスト処理を実装する
  - クライアントがIf-None-Matchヘッダーを送信し、ETagが一致する場合はHTTP 304ステータスコードを返す
  - HTTP 304レスポンスの場合はレスポンスボディを送信せず、ヘッダーのみ送信する
  - ETagが異なる場合はHTTP 200ステータスコードと完全なレスポンスボディを返す
  - ETag生成処理によるレスポンス時間への影響を10ms未満に抑える
  - レスポンスボディサイズが1MB以上の場合はETag生成をスキップする
  - _Requirements: 9.3, 9.4, 9.5, 9.6, 9.7_

- [ ] 12. JSON入出力の強制とAPI統一性機能の実装
- [ ] 12.1 JSON入出力強制機能を実装する
  - 全てのAPIエンドポイントでJSON形式の入出力を強制する
  - Acceptヘッダーがapplication/json以外の場合はHTTP 406ステータスコードを返す
  - POST/PUT/PATCHリクエストのContent-Typeがapplication/json以外の場合はHTTP 415ステータスコードを返す
  - エラー応答を統一されたJSON形式で返す
  - 例外が発生した場合も統一されたJSON形式のエラー応答を返す
  - _Requirements: 10.1, 10.2, 10.3, 10.4, 10.5_

- [ ] 13. ミドルウェアグループ化とルート適用設定
- [ ] 13.1 apiグループミドルウェアを設定する
  - 全てのAPIエンドポイントに適用される基底グループを設定する
  - TrimStrings、ConvertEmptyStringsToNull、SubstituteBindingsを含める
  - RequestLogging、PerformanceTracking、EnhancedRateLimitを含める
  - SecurityHeaders、ContentSecurityPolicyを含める
  - _Requirements: 11.1, 11.2, 16.2, 16.3_

- [ ] 13.2 authグループミドルウェアを設定する
  - 認証必須エンドポイントに適用されるグループを設定する
  - apiグループに加えて、auth:sanctum、TokenValidation、AuditTrailを含める
  - _Requirements: 11.3, 11.4, 16.1_

- [ ] 13.3 guestグループミドルウェアを設定する
  - 公開APIエンドポイント（認証不要）に適用されるグループを設定する
  - apiグループに加えて、EnhancedRateLimit:publicを含める
  - _Requirements: 11.5, 11.6_

- [ ] 13.4 internal、webhook、readonlyグループミドルウェアを設定する
  - 内部/管理用エンドポイントに適用されるinternalグループを設定する（auth:sanctum、PermissionCheck:admin、EnhancedRateLimit:strict、AuditTrail）
  - Webhookエンドポイントに適用されるwebhookグループを設定する（IdempotencyKey、EnhancedRateLimit:webhook）
  - 読み取り専用エンドポイントに適用されるreadonlyグループを設定する（CacheHeaders、ETag）
  - _Requirements: 11.7, 11.8, 11.9, 11.10, 11.11, 11.12_

- [ ] 14. グローバルミドルウェアと実行順序設定
- [ ] 14.1 グローバルミドルウェアチェーンを設定する
  - 全てのリクエストに適用されるグローバルミドルウェアを定義する
  - 実行順序を明確に定義する（TrustProxies、ValidatePostSize、PreventRequestsDuringMaintenance、Cors、SetRequestId、CorrelationId、ForceJsonResponse）
  - グローバルミドルウェア実行後にルート固有のミドルウェアグループを実行する
  - 既存ミドルウェア（Sanctum、SecurityHeaders、CSP、CORS）との統合を保証する
  - _Requirements: 12.1, 12.2, 12.3, 16.4, 16.5_

- [ ] 14.2 bootstrap/app.phpでミドルウェアを登録する
  - グローバルミドルウェア、ミドルウェアグループ、ミドルウェアエイリアスを明確に定義する
  - Laravel 12の新しいミドルウェア登録APIを使用する
  - _Requirements: 12.4_

- [ ] 15. 単体テストの実装
- [ ] 15.1 基盤ミドルウェアの単体テストを実装する
  - SetRequestId、CorrelationId、ForceJsonResponseの単体テストを実装する
  - 各ミドルウェアの個別動作を検証する
  - 正常系と異常系のテストケースを含める
  - _Requirements: 14.1, 14.2, 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 10.1, 10.2, 10.3_

- [ ] 15.2 ロギングとメトリクス収集の単体テストを実装する
  - RequestLogging、PerformanceTrackingの単体テストを実装する
  - 構造化ログ出力、機密データマスキング、パフォーマンスメトリクス収集を検証する
  - 非同期処理（terminateメソッド）の動作を検証する
  - _Requirements: 14.1, 14.2, 1.8, 1.9, 1.10, 2.1, 2.2, 2.3, 2.6_

- [ ] 15.3 レート制限と認証の単体テストを実装する
  - EnhancedRateLimit、TokenValidationの単体テストを実装する
  - レート制限超過、レート制限ヘッダー設定、トークン有効期限検証を検証する
  - Redisダウン時のグレースフルデグラデーションを検証する
  - _Requirements: 14.1, 14.2, 3.1, 3.6, 3.10, 4.1, 4.2_

- [ ] 15.4 権限検証と監査の単体テストを実装する
  - PermissionCheck、AuditTrailの単体テストを実装する
  - Application層ポートをモック化してテストする
  - 権限検証成功/失敗、監査イベント記録を検証する
  - _Requirements: 14.1, 14.2, 15.6, 5.1, 5.3, 6.1, 6.3_

- [ ] 15.5 Idempotency、キャッシュ、ETagの単体テストを実装する
  - IdempotencyKey、CacheHeaders、ETagの単体テストを実装する
  - Idempotencyキー検証、キャッシュヘッダー設定、ETag生成と条件付きGET処理を検証する
  - _Requirements: 14.1, 14.2, 7.1, 7.4, 8.1, 8.3, 9.1, 9.3_

- [ ] 15.6 単体テストカバレッジ検証
  - 単体テストカバレッジを測定し、90%以上を達成する
  - カバレッジレポートを生成し、未カバー箇所を特定する
  - _Requirements: 14.2_

- [ ] 16. 統合テストの実装
- [ ] 16.1 ミドルウェアチェーン統合テストを実装する
  - ミドルウェアチェーン全体の動作を検証する統合テストを実装する
  - グローバルミドルウェアからルート固有ミドルウェアまでの実行順序を検証する
  - 各ミドルウェア間のデータ伝播（リクエストID、Correlation ID）を検証する
  - _Requirements: 14.3_

- [ ] 16.2 ミドルウェアグループ別統合テストを実装する
  - 6種類のミドルウェアグループ別の動作を検証する統合テストを実装する
  - api、auth、guest、internal、webhook、readonlyグループの動作を検証する
  - 各グループで期待されるミドルウェアセットが適用されることを検証する
  - _Requirements: 14.4_

- [ ] 17. E2Eテストの実装
- [ ] 17.1 レート制限E2Eテストを実装する
  - Playwrightを使用してレート制限の動作を実際のHTTPリクエストで検証する
  - レート制限超過時のHTTP 429レスポンスを検証する
  - レート制限ヘッダーの設定を検証する
  - _Requirements: 14.5, 14.6_

- [ ] 17.2 IdempotencyとパフォーマンスE2Eテストを実装する
  - Playwrightを使用してIdempotency機能の動作を実際のHTTPリクエストで検証する
  - 同じIdempotencyキーでの2回目のリクエストがキャッシュ済みレスポンスを返すことを検証する
  - パフォーマンスメトリクス収集の動作を検証する（レスポンス時間測定）
  - _Requirements: 14.5, 14.6_

- [ ] 18. CI/CDワークフロー統合
- [ ] 18.1 ミドルウェア専用テストワークフローを作成する
  - GitHub Actionsにミドルウェア専用テストワークフローを作成する
  - Pull Request時に自動実行されるように設定する
  - 単体テスト、統合テスト、E2Eテストを順次実行する
  - テスト失敗時はPRマージをブロックする
  - _Requirements: 14.7, 14.8_

- [ ] 18.2 CI/CD最適化設定を追加する
  - Paths Filter設定を追加し、ミドルウェアファイル変更時のみワークフローを実行する
  - Concurrency設定を追加し、PR内の連続コミットで古い実行を自動キャンセルする
  - Composerキャッシングを設定し、テスト実行時間を短縮する
  - _Requirements: 14.8_

- [ ] 19. ドキュメント整備
- [ ] 19.1 ミドルウェア実装ガイドを作成する
  - ミドルウェア一覧、各ミドルウェアの責務、実装パターンを記載する
  - ミドルウェアグループの説明と適用条件を記載する
  - コード例を含めた実装ガイドを記載する
  - DDD/クリーンアーキテクチャ統合パターンを記載する
  - _Requirements: 17.1_

- [ ] 19.2 ミドルウェア運用マニュアルを作成する
  - 監視項目、ログ確認手順、トラブルシューティングを記載する
  - レート制限調整方法、パフォーマンスメトリクス確認方法を記載する
  - 環境変数設定ガイドとよくある問題の解決方法を記載する
  - _Requirements: 17.2_

- [ ] 19.3 README.mdを更新する
  - ミドルウェア設定概要を追記する
  - 主要ミドルウェアの説明を追記する
  - 設定ファイル一覧とミドルウェアグループ説明を追記する
  - 環境変数設定方法を追記する
  - _Requirements: 17.3_

- [ ] 19.4 設定ファイルにコメントを追加する
  - 各設定ファイルの設定項目にコメントで説明を追加する
  - 推奨設定値と設定変更時の影響を記載する
  - _Requirements: 17.4_

## タスク実行順序の注意点

- タスク1（Application層ポート設計）は、権限検証（タスク7）と監査証跡（タスク8）の実装に必要な前提条件です
- タスク2（環境設定）は、全てのミドルウェア実装（タスク3-12）で使用される設定ファイルを提供します
- タスク3-12のミドルウェア実装は、相互依存が少ないため並行して進めることが可能です
- タスク13-14（ミドルウェアグループ化とグローバルミドルウェア設定）は、全てのミドルウェア実装（タスク3-12）が完了してから実行します
- タスク15-17（テスト実装）は、対応するミドルウェア実装が完了してから実行します
- タスク18（CI/CDワークフロー）は、全てのテスト実装（タスク15-17）が完了してから実行します
- タスク19（ドキュメント整備）は、全ての実装とテストが完了してから実行します

## 要件カバレッジマトリクス

全17要件が以下のタスクでカバーされています：

- **Requirement 1 (リクエストトレーシングとロギング)**: タスク3
- **Requirement 2 (パフォーマンスメトリクス)**: タスク4
- **Requirement 3 (動的レート制限)**: タスク5
- **Requirement 4 (Sanctumトークン詳細検証)**: タスク6
- **Requirement 5 (権限ベースアクセス制御)**: タスク7
- **Requirement 6 (監査証跡)**: タスク8
- **Requirement 7 (Idempotency保証)**: タスク9
- **Requirement 8 (キャッシュ制御)**: タスク10
- **Requirement 9 (ETag)**: タスク11
- **Requirement 10 (JSON入出力強制)**: タスク12
- **Requirement 11 (ミドルウェアグループ化)**: タスク13
- **Requirement 12 (グローバルミドルウェア)**: タスク14
- **Requirement 13 (環境変数駆動設定)**: タスク2
- **Requirement 14 (テスト環境)**: タスク15, 16, 17, 18
- **Requirement 15 (DDD/クリーンアーキテクチャ統合)**: タスク1
- **Requirement 16 (既存ミドルウェア統合)**: タスク13, 14
- **Requirement 17 (ドキュメント)**: タスク19
