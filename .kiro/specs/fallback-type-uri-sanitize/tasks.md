# 実装計画

## タスク一覧

- [ ] 1. サニタイズロジックの実装
- [ ] 1.1 HasProblemDetailsトレイトにフォールバックURI生成時のサニタイズ処理を追加
  - `toProblemDetails()`メソッドにインラインサニタイズロジックを実装
  - 正規表現 `/[^a-z0-9\-]/` を使用して安全な文字セットのみを許可
  - 小文字変換（`strtolower()`）後にサニタイズ処理を適用
  - 空文字列の場合はデフォルト値 `unknown` を設定
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5_

- [ ] 1.2 元のエラーコード文字列の保持機能を確認
  - `error_code` フィールドにサニタイズ前の元のエラーコード文字列が保持されることを確認
  - RFC 7807レスポンスの `type` フィールド（サニタイズ済み）と `error_code` フィールド（サニタイズ前）の両方が正しく出力されることを確認
  - _Requirements: 2.1, 2.2, 2.3_

- [ ] 1.3 PHPDocコメントとコードコメントの追加
  - サニタイズ処理の目的（セキュリティ強化、RFC 3986準拠）を明記
  - 正規表現パターン、空文字列のデフォルト値の説明を追加
  - Codexレビュー指摘（PR #141）を実装の背景として引用
  - _Requirements: 6.1, 6.2, 6.4_

- [ ] 2. ユニットテストの実装
- [ ] 2.1 HasProblemDetailsトレイトのサニタイズパターンテストを作成
  - 正常系: `CUSTOM_ERROR_001` → `customerror001`
  - アンダースコア削除: `CUSTOM_ERROR` → `customerror`
  - 特殊文字削除: `CUSTOM@ERROR!` → `customerror`
  - 空白削除: `CUSTOM ERROR` → `customerror`
  - 全削除（空文字列）: `@#$%` → `unknown`（デフォルト文字列）
  - 数字・ハイフン保持: `ERROR-123-TEST` → `error-123-test`
  - _Requirements: 5.1_

- [ ] 2.2 ErrorCode enum定義済みエラーの既存動作テストを追加
  - `ErrorCode::fromString()` が有効なインスタンスを返す場合、サニタイズ処理が実行されないことを検証
  - `ErrorCode::getType()` の戻り値がそのまま `type` フィールドに使用されることを検証
  - 既存のtype URI生成結果が変更されていないことを確認
  - _Requirements: 4.1, 4.2, 4.3, 4.4_

- [ ] 2.3 RFC 3986準拠の文字セット検証テストを追加
  - フォールバックtype URIに英数字（小文字）とハイフンのみが含まれることを検証
  - URI安全性検証（RFC 3986のunreserved文字セットサブセット `[a-z0-9\-]`）
  - _Requirements: 3.1, 3.2, 3.3_

- [ ] 3. Feature Testsの実装
- [ ] 3.1 未定義エラーコードのHTTPレスポンステストを作成
  - 未定義エラーコードを返すHTTPリクエストを送信
  - RFC 7807準拠のレスポンスが返されることを検証
  - `type` フィールドがサニタイズ済みURIであることを確認
  - `error_code` フィールドがサニタイズ前の元のエラーコードであることを確認
  - _Requirements: 5.3_

- [ ] 3.2 ErrorCode enum定義済みエラーのHTTPレスポンステストを追加
  - 定義済みエラーコードを返すHTTPリクエストを送信
  - `type` フィールドが `ErrorCode::getType()` の戻り値と一致することを検証
  - サニタイズ処理が実行されていないことを確認
  - _Requirements: 4.1, 4.2_

- [ ] 3.3 空文字列デフォルト値のHTTPレスポンステストを追加
  - 特殊文字のみのエラーコードを返すHTTPリクエストを送信
  - `type` フィールドが `https://api.example.com/errors/unknown` であることを検証
  - `error_code` フィールドに元の特殊文字エラーコードが保持されていることを確認
  - _Requirements: 1.5, 2.1_

- [ ] 4. Architecture Testsの実装
- [ ] 4.1 HasProblemDetailsトレイト使用検証テストを追加
  - `ddd/**/Exceptions/` 配下の全例外クラスが `HasProblemDetails` トレイトを使用していることを検証
  - `toProblemDetails()` メソッドが正しく実装されていることを確認
  - _Requirements: 5.2_

- [ ] 5. テストカバレッジの検証と最適化
- [ ] 5.1 テストカバレッジを計測し85%以上を達成
  - HasProblemDetailsトレイトのコードカバレッジを100%にする
  - サニタイズロジックの全コードパスをカバー
  - `./vendor/bin/pest --coverage` でカバレッジレポートを生成
  - _Requirements: 5.4_

- [ ] 5.2 PHPStan Level 8静的解析を実行し型安全性を検証
  - `./vendor/bin/phpstan analyse` で静的解析を実行
  - 型安全性の問題がないことを確認
  - _Requirements: Technical Constraints - PHPStan Level 8_

- [ ] 6. ドキュメント更新
- [ ] 6.1 tech.mdにフォールバックURI生成時のサニタイズ処理を記載
  - RFC 7807エラーハンドリングセクションにサニタイズ処理の説明を追加
  - 正規表現パターン、デフォルト値、セキュリティ向上の目的を記載
  - _Requirements: 6.3_

## 要件カバレッジチェック

| 要件ID | 要件概要 | 対応タスク |
|--------|----------|-----------|
| 1.1 | フォールバックURI生成前にサニタイズ処理を実施 | 1.1 |
| 1.2 | 正規表現 `/[^a-z0-9\-]/` を使用 | 1.1 |
| 1.3 | 小文字変換後にサニタイズ処理を適用 | 1.1 |
| 1.4 | サニタイズ済み文字列を `config('app.url').'/errors/'` に連結 | 1.1 |
| 1.5 | 空文字列の場合はデフォルト文字列 `unknown` を使用 | 1.1, 3.3 |
| 2.1 | `error_code` フィールドに元のエラーコード文字列を保持 | 1.2, 3.3 |
| 2.2 | `type` と `error_code` の両方を含むRFC 7807レスポンス | 1.2 |
| 2.3 | `error_code` フィールドで元のエラーコードを確認可能 | 1.2 |
| 3.1 | RFC 3986で定義される安全な文字セット `[a-z0-9\-]` のみを許可 | 1.1, 2.3 |
| 3.2 | URI内に英数字（小文字）とハイフンのみが含まれることを保証 | 2.3 |
| 3.3 | RFC 3986のunreserved文字セットサブセット `[a-z0-9\-]` を使用 | 2.3 |
| 4.1 | ErrorCode::fromString()が有効な場合、サニタイズ処理を実行しない | 2.2, 3.2 |
| 4.2 | ErrorCode enum定義済みエラーの既存type URI生成ロジックに影響を与えない | 2.2, 3.2 |
| 4.3 | フォールバックURI生成時のみサニタイズ処理を適用 | 2.2 |
| 4.4 | 既存テストスイートで全テストケースのtype URI生成結果が変更されないことを保証 | 2.2 |
| 5.1 | 6つのサニタイズパターンを検証 | 2.1 |
| 5.2 | Architecture TestsでHasProblemDetailsトレイト使用を検証 | 4.1 |
| 5.3 | Feature Testsで未定義エラーコードのRFC 7807レスポンスを検証 | 3.1 |
| 5.4 | HasProblemDetailsトレイトで85%以上のコードカバレッジを達成 | 5.1 |
| 6.1 | コードコメントにサニタイズ処理の目的を明記 | 1.3 |
| 6.2 | PHPDocコメントにサニタイズ処理のロジックを説明 | 1.3 |
| 6.3 | tech.mdにフォールバックURI生成時のサニタイズ処理を記載 | 6.1 |
| 6.4 | Codexレビュー指摘を実装の背景として引用 | 1.3 |

## 実装順序の理由

1. **サニタイズロジックの実装** (タスク1): コア機能の実装を最優先
2. **ユニットテストの実装** (タスク2): サニタイズロジックの詳細な動作検証
3. **Feature Testsの実装** (タスク3): HTTPレスポンスレベルでの統合検証
4. **Architecture Testsの実装** (タスク4): アーキテクチャ整合性の検証
5. **テストカバレッジの検証と最適化** (タスク5): 品質保証の最終確認
6. **ドキュメント更新** (タスク6): 実装の意図と背景を記録

## 見積もり

- **総タスク数**: 6個の主要タスク、11個のサブタスク
- **総見積もり時間**: 約8-12時間
  - タスク1: 2-3時間（サニタイズロジック実装 + コメント追加）
  - タスク2: 2-3時間（6パターンのユニットテスト + 既存動作検証テスト）
  - タスク3: 1-2時間（3つのFeature Tests実装）
  - タスク4: 1時間（Architecture Tests追加）
  - タスク5: 1-2時間（カバレッジ検証 + PHPStan実行）
  - タスク6: 1時間（ドキュメント更新）
