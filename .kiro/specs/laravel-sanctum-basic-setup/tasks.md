# 実装計画

## 概要
本実装計画は、Laravel Sanctum 4.0を用いたトークンベースAPI認証機能を、既存のステートレスAPI設計を維持しながら段階的に実装します。全10の要件を17のタスクに分解し、各タスクは自然言語でビジネス機能と期待される動作を記述しています。

## 実装タスク

- [x] 1. Sanctum設定とデータベース準備
- [x] 1.1 Sanctum設定ファイルの最適化
  - 既存のSanctum設定ファイルをステートレスAPI専用に最適化
  - トークン有効期限とガード設定を構成
  - ステートフルドメイン設定を空配列に保持（既存のステートレス設計維持）
  - APIガード専用設定を確認
  - _Requirements: 1.1, 1.2, 1.3_

- [x] 1.2 personal_access_tokensマイグレーション実行
  - Sanctumのpersonal_access_tokensテーブルマイグレーションを実行
  - tokenable_idカラムがUUID/ULID対応（VARCHAR型）であることを確認
  - 既存のUserモデル主キー型（string）との互換性確認
  - インデックス設定の確認
  - _Requirements: 1.4, 1.5_

- [x] 2. 認証エンドポイント実装
- [x] 2.1 ログイン機能の実装
  - ユーザーがメールアドレスとパスワードでログインできる機能を実装
  - 認証成功時にAPIトークンを発行し返却
  - 認証失敗時に適切なエラーレスポンスを返却
  - メールアドレスとパスワードのバリデーション処理
  - _Requirements: 3.1, 3.2, 3.3_

- [x] 2.2 ログアウト機能の実装
  - 認証済みユーザーが現在のトークンを失効させる機能を実装
  - トークン失効後に成功メッセージを返却
  - 未認証ユーザーのアクセス時にエラーを返却
  - _Requirements: 3.4_

- [x] 2.3 認証済みユーザー情報取得機能の実装
  - 認証済みユーザーが自身の情報を取得できる機能を実装
  - トークン検証後にユーザー情報を返却
  - 未認証アクセス時に401エラーを返却
  - _Requirements: 3.5, 3.6_

- [x] 3. トークン管理機能実装
- [x] 3.1 新規トークン発行機能の実装
  - 認証済みユーザーが新しいAPIトークンを発行できる機能を実装
  - トークン名の指定をサポート（オプション）
  - 発行されたトークンを平文で返却（初回のみ）
  - _Requirements: 6.1, 6.2_

- [x] 3.2 トークン一覧取得機能の実装
  - 認証済みユーザーが自身の発行済みトークン一覧を取得できる機能を実装
  - トークンID、名前、作成日時、最終使用日時を返却
  - トークンの平文は返却しない（セキュリティ）
  - _Requirements: 6.3_

- [x] 3.3 トークン削除機能の実装
  - 認証済みユーザーが特定のトークンを削除できる機能を実装
  - 認証済みユーザーが全トークンを削除できる機能を実装
  - 存在しないトークンID指定時に404エラーを返却
  - 他のユーザーのトークン削除を防止
  - _Requirements: 6.4, 6.5_

- [x] 4. 認証ミドルウェア設定
- [x] 4.1 auth:sanctumミドルウェア設定
  - 保護されたAPIルートにauth:sanctumミドルウェアを適用
  - 認証されていないユーザーのアクセス時に401エラーを返却
  - 無効なトークンでのアクセス時に401エラーを返却
  - 既存のミドルウェア設定との統合確認
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5_

- [x] 5. CORS設定の確認と調整
- [x] 5.1 CORS設定の検証
  - Next.js Admin App（localhost:13002）とUser App（localhost:13001）からのCORSアクセスを検証
  - 必要なHTTPメソッド（GET, POST, PUT, DELETE, OPTIONS）の許可確認
  - 必要なヘッダー（Content-Type, Authorization, X-Requested-With）の許可確認
  - プリフライトリクエスト（OPTIONS）の正常動作確認
  - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5_

- [x] 6. セキュリティ設定強化
- [x] 6.1 トークンセキュリティ設定
  - トークンがSHA-256ハッシュ化されてデータベースに保存されることを確認
  - トークン有効期限設定の構成（本番環境推奨値）
  - レート制限ミドルウェアの設定（ログイン: 5回/分、その他: 60回/分）
  - パスワードハッシュ化（bcrypt/argon2）の確認
  - _Requirements: 9.1, 9.2, 9.4, 9.5_

- [x] 6.2 本番環境セキュリティ設定
  - HTTPS通信強制設定の構成（本番環境）
  - 未使用トークン自動削除スケジュールコマンドの作成
  - セキュリティヘッダー設定の確認（CSP推奨）
  - _Requirements: 9.3, 9.6_

- [x] 7. 認証テストスイート実装（Pest 4）
- [x] 7.1 ログイン機能テストの実装
  - 正常なログイン成功シナリオのテスト（トークン発行確認）
  - 不正なメールアドレスでの401エラーテスト
  - 不正なパスワードでの401エラーテスト
  - バリデーションエラー（メールアドレス形式不正、パスワード短すぎる）のテスト
  - _Requirements: 7.1, 7.2_

- [x] 7.2 認証済みエンドポイントテストの実装
  - 有効なトークンでの認証済みアクセステスト
  - トークンなしでの未認証アクセス時の401エラーテスト
  - 無効なトークンでの401エラーテスト
  - _Requirements: 7.3_

- [x] 7.3 トークン管理機能テストの実装
  - トークン発行成功シナリオのテスト（トークン名指定含む）
  - トークン一覧取得テスト（last_used_at更新確認）
  - 特定トークン削除成功シナリオのテスト
  - 全トークン削除成功シナリオのテスト
  - 存在しないトークン削除時の404エラーテスト
  - _Requirements: 7.4_

- [x] 7.4 ログアウト機能テストの実装
  - 認証済みユーザーのログアウト成功シナリオのテスト
  - ログアウト後のトークン失効確認テスト
  - 未認証ユーザーのログアウトリクエスト時の401エラーテスト
  - _Requirements: 7.5_

- [x] 8. Next.jsフロントエンド統合準備
- [x] 8.1 フロントエンド認証統合ドキュメント作成
  - Next.js Admin AppおよびUser Appからのログイン実装ガイド作成
  - トークン保存方法（localStorage）の説明
  - 保護されたAPIアクセス方法（Bearerトークン）の説明
  - ログアウト実装ガイド作成
  - 401エラー時のリダイレクト処理説明
  - _Requirements: 8.1, 8.2, 8.3, 8.4, 8.5, 8.6_

- [x] 9. ドキュメント整備
- [x] 9.1 Sanctum認証ドキュメント作成
  - Sanctumインストール手順の記載
  - 設定ファイル説明（config/sanctum.php）
  - 認証エンドポイント一覧（API仕様）の記載
  - リクエスト/レスポンス例の記載
  - フロントエンド統合ガイド（Next.js例）の記載
  - トラブルシューティングガイドの作成（CORS設定エラー、トークン検証失敗、401エラー、マイグレーションエラー）
  - _Requirements: 10.1, 10.2, 10.3, 10.4_

## 要件カバレッジ確認

### Requirement 1: Sanctum基本設定とインストール
- タスク 1.1, 1.2でカバー

### Requirement 2: Userモデル設定
- 既存実装で完了（HasApiTokensトレイト追加済み）、検証のみ実施

### Requirement 3: 認証エンドポイント実装
- タスク 2.1, 2.2, 2.3でカバー

### Requirement 4: 認証ミドルウェア設定
- タスク 4.1でカバー

### Requirement 5: CORS設定最適化
- タスク 5.1でカバー（既存設定の検証と調整）

### Requirement 6: トークン管理機能
- タスク 3.1, 3.2, 3.3でカバー

### Requirement 7: テストカバレッジ（Pest 4）
- タスク 7.1, 7.2, 7.3, 7.4でカバー

### Requirement 8: Next.jsフロントエンド統合
- タスク 8.1でカバー（統合ドキュメント作成）

### Requirement 9: セキュリティ設定
- タスク 6.1, 6.2でカバー

### Requirement 10: ドキュメント整備
- タスク 9.1でカバー

## 実装順序の根拠

1. **Phase 1（タスク1）**: インフラ基盤整備 - Sanctum設定とデータベーステーブル作成
2. **Phase 2（タスク2-3）**: コア認証機能実装 - ログイン/ログアウト/トークン管理
3. **Phase 3（タスク4-5）**: セキュリティ層実装 - ミドルウェアとCORS設定
4. **Phase 4（タスク6）**: セキュリティ強化 - トークン保護とレート制限
5. **Phase 5（タスク7）**: 品質保証 - 包括的テストスイート実装
6. **Phase 6（タスク8-9）**: 統合とドキュメント整備 - フロントエンド統合準備

各タスクは前のタスクの成果物を活用し、段階的に機能を統合します。
