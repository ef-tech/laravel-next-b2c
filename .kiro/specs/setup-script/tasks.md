# Implementation Plan

## 実装タスク概要

本ドキュメントは、Laravel 12 + Next.js 15.5モノレポ環境の一括セットアップスクリプトの実装タスクリストです。`make setup` コマンド一つで完全な開発環境を15分以内に構築できる自動化スクリプトを段階的に実装します。

## タスクリスト

- [x] 1. 共通ライブラリとユーティリティ関数の実装（完了）
- [x] 1.1 共通ライブラリファイルの作成とログ機能の実装
  - 共通ライブラリファイルを作成し、基本構造を定義 ✅
  - 情報ログ、警告ログ、エラーログの出力機能を実装（カラーコード対応） ✅
  - ログファイルへの記録機能を実装（タイムスタンプ付き） ✅
  - 機密情報マスキング機能を実装（パスワード、トークン、APIキーの自動マスキング） ✅
  - CI/CDモード判定とカラーコード無効化機能を実装 ✅
  - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.5, 7.6, 11.2_

- [x] 1.2 OS検出と環境差異対応機能の実装
  - 実行環境の自動検出機能を実装（macOS/Linux/WSL2） ✅
  - パッケージマネージャーの推奨機能を実装（Homebrew/apt/yum） ✅
  - 環境別のインストールガイド生成機能を実装 ✅
  - ファイルパス処理の環境対応機能を実装 ✅
  - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5, 6.6_

- [x] 1.3 進捗管理機能の実装
  - 進捗マーカーファイルの読み込み機能を実装（JSON解析） ✅
  - 進捗マーカーファイルの保存機能を実装（JSON形式） ✅
  - ステップ完了チェック機能を実装 ✅
  - マーカーファイル削除機能を実装（セットアップ完了時） ✅
  - 進捗表示機能を実装（X/Yステップ形式） ✅
  - _Requirements: 5.1, 5.9, 5.10, 7.1_

- [x] 1.4 リトライロジックの実装
  - 指数バックオフリトライ機能を実装（1秒 → 2秒 → 4秒） ✅
  - 最大リトライ回数制御機能を実装（3回まで） ✅
  - リトライ時のログ出力機能を実装 ✅
  - リトライ失敗時のエラー処理機能を実装 ✅
  - _Requirements: 3.7, 3.8, 5.3_

- [x] 1.5 パフォーマンス測定機能の実装
  - ステップ実行時間測定機能を実装 ✅
  - 全体所要時間集計機能を実装 ✅
  - パフォーマンスサマリー表示機能を実装 ✅
  - ボトルネック特定機能を実装（10分超過時警告） ✅
  - _Requirements: 7.2, 7.7, 7.8, 10.1, 10.5_

- [ ] 2. 前提条件チェック機能の実装
- [ ] 2.1 バージョンチェック機能の実装
  - Dockerバージョンチェック機能を実装（20.10.0以上）
  - Docker Composeバージョンチェック機能を実装（2.0.0以上）
  - Node.jsバージョンチェック機能を実装（18.0.0以上）
  - PHPバージョンチェック機能を実装（8.4.0以上）
  - makeコマンド存在確認機能を実装
  - バージョン不足時のエラーメッセージとインストールガイド表示機能を実装
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 1.9_

- [ ] 2.2 システムリソースチェック機能の実装
  - ポート利用可能性チェック機能を実装（13000-13010番台、9ポート）
  - ポート競合時のプロセスID・ポート番号表示機能を実装
  - ディスク空き容量チェック機能を実装（10GB以上）
  - 利用可能メモリチェック機能を実装（4GB以上）
  - リソース不足時のエラーメッセージ表示機能を実装
  - _Requirements: 1.6, 1.7, 1.8, 1.9, 5.7_

- [ ] 2.3 前提条件チェックスクリプトの統合
  - 前提条件チェックスクリプトファイルを作成
  - バージョンチェック機能を統合
  - システムリソースチェック機能を統合
  - チェック結果のログ出力機能を実装
  - エラー時のセットアップ中断機能を実装
  - _Requirements: 1.10_

- [ ] 3. 環境変数セットアップ機能の実装
- [ ] 3.1 環境変数ファイルコピー機能の実装
  - Laravel API環境変数ファイルコピー機能を実装（.env.example → .env）
  - User App環境変数ファイルコピー機能を実装（.env.example → .env.local）
  - Admin App環境変数ファイルコピー機能を実装（.env.example → .env.local）
  - 既存ファイル保護機能を実装（上書きせず警告表示）
  - ファイルパーミッション設定機能を実装（600権限）
  - _Requirements: 2.1, 2.2, 2.3, 2.6, 11.5_

- [ ] 3.2 APP_KEY生成と環境変数バリデーション機能の実装
  - Laravel APP_KEY自動生成機能を実装（php artisan key:generate）
  - 環境変数バリデーション機能を実装（必須項目存在確認）
  - バリデーションエラー時の不足項目一覧表示機能を実装
  - 推奨値提示機能を実装
  - _Requirements: 2.4, 2.5, 2.7, 5.6_

- [ ] 3.3 セキュリティチェック機能の実装
  - .gitignoreファイル確認機能を実装（.envファイル除外チェック）
  - .env未除外時のエラー表示機能を実装
  - ログ出力時の機密情報マスキング機能の統合
  - 一時ファイル管理機能を実装
  - _Requirements: 2.8, 11.1, 11.2, 11.3_

- [ ] 3.4 環境変数セットアップスクリプトの統合
  - 環境変数セットアップスクリプトファイルを作成
  - ファイルコピー機能を統合
  - APP_KEY生成・バリデーション機能を統合
  - セキュリティチェック機能を統合
  - セットアップ結果のログ出力機能を実装
  - _Requirements: Requirement 2全体_

- [ ] 4. 依存関係インストール機能の実装
- [ ] 4.1 Composer依存関係インストール機能の実装
  - Composerインストールコマンド実行機能を実装（--no-interaction --prefer-dist）
  - リトライロジック統合機能を実装（ネットワークエラー対応）
  - インストール成功時のログ出力機能を実装（パッケージ数、所要時間）
  - インストール失敗時のエラーログと解決ガイド表示機能を実装
  - Composerキャッシュ活用確認機能を実装
  - _Requirements: 3.1, 3.7, 3.8, 3.9, 10.3_

- [ ] 4.2 npm依存関係インストール機能の実装
  - npmインストールコマンド実行機能を実装（モノレポワークスペース対応）
  - リトライロジック統合機能を実装
  - インストール成功時のログ出力機能を実装
  - インストール失敗時のエラーログと解決ガイド表示機能を実装
  - npmキャッシュ活用確認機能を実装
  - _Requirements: 3.2, 3.7, 3.8, 3.9, 10.3_

- [ ] 4.3 Dockerイメージプル機能の実装
  - PostgreSQLイメージプル機能を実装
  - Redisイメージプル機能を実装
  - Mailpitイメージプル機能を実装
  - MinIOイメージプル機能を実装
  - 並列プル機能を実装（docker compose pull）
  - リトライロジック統合機能を実装
  - プル成功時のログ出力機能を実装
  - _Requirements: 3.3, 3.4, 3.5, 3.6, 3.7, 10.4_

- [ ] 4.4 依存関係インストールスクリプトの統合
  - 依存関係インストールスクリプトファイルを作成
  - Composerインストール機能を統合
  - npmインストール機能を統合
  - Dockerイメージプル機能を統合
  - 全体所要時間測定機能を実装
  - _Requirements: Requirement 3全体_

- [ ] 5. サービス起動・初期化機能の実装
- [ ] 5.1 Docker Composeサービス起動機能の実装
  - Docker Compose起動コマンド実行機能を実装（docker compose up -d）
  - サービス起動ログ出力機能を実装
  - 起動エラー時のログ収集機能を実装
  - エラー時のトラブルシューティングガイド表示機能を実装
  - _Requirements: 4.1, 5.5_

- [ ] 5.2 ヘルスチェック待機機能の実装
  - PostgreSQLヘルスチェック待機機能を実装（最大60秒）
  - Redisヘルスチェック待機機能を実装（最大30秒）
  - Laravel APIヘルスチェック待機機能を実装（/api/health、最大90秒）
  - タイムアウト時のサービスログ出力機能を実装
  - タイムアウト時のトラブルシューティングガイド表示機能を実装
  - _Requirements: 4.2, 4.3, 4.4, 4.9_

- [ ] 5.3 データベース初期化機能の実装
  - データベースマイグレーション実行機能を実装（php artisan migrate --force）
  - シーディング実行機能を実装（php artisan db:seed）
  - 初期化成功時のログ出力機能を実装
  - 初期化失敗時のエラーログとトラブルシューティング表示機能を実装
  - _Requirements: 4.5, 4.6_

- [ ] 5.4 フロントエンドアプリ起動確認機能の実装
  - User Appヘルスチェック確認機能を実装（ポート13001）
  - Admin Appヘルスチェック確認機能を実装（ポート13002）
  - 起動確認成功時のログ出力機能を実装
  - 起動確認失敗時のエラーログ表示機能を実装
  - _Requirements: 4.7, 4.8_

- [ ] 5.5 サービス起動完了サマリー表示機能の実装
  - アクセスURL表示機能を実装（Laravel API、User App、Admin App）
  - 次のステップガイド表示機能を実装
  - 全体所要時間表示機能を実装
  - _Requirements: 4.10_

- [ ] 5.6 サービス起動スクリプトの統合
  - サービス起動スクリプトファイルを作成
  - Docker Compose起動機能を統合
  - ヘルスチェック待機機能を統合
  - データベース初期化機能を統合
  - フロントエンドアプリ起動確認機能を統合
  - サマリー表示機能を統合
  - _Requirements: Requirement 4全体_

- [ ] 6. エラーハンドリングとリカバリ機能の統合
- [ ] 6.1 エラーハンドリング統合機能の実装
  - エラー種別検出機能を実装（ネットワーク、ポート競合、権限、バージョン）
  - エラー種別ごとの処理分岐機能を実装
  - エラーログ記録機能を統合
  - エラー発生ステップ特定機能を実装
  - _Requirements: 5.2, 5.5, 5.6, 5.7, 5.8_

- [ ] 6.2 部分的再実行機能の実装
  - コマンドライン引数解析機能を実装（--from <step>オプション）
  - 指定ステップからの再実行機能を実装
  - 進捗マーカー読み込みによるスキップ機能の統合
  - 無効なステップ名検出とエラー表示機能を実装
  - _Requirements: 5.4, 5.10_

- [ ] 6.3 CI/CDモード対応機能の実装
  - CI/CDモード検出機能を実装（--ciフラグ）
  - 対話的プロンプト無効化機能を実装
  - カラーコード出力無効化機能の統合
  - 終了コード適切設定機能を実装（0=成功、1以上=失敗）
  - GitHub Actions annotations形式エラー出力機能を実装
  - タイムアウト時間制御機能を実装（SETUP_TIMEOUT環境変数）
  - _Requirements: 8.1, 8.2, 8.3, 8.4, 8.5, 8.6_

- [ ] 7. セットアップ検証機能の実装
- [ ] 7.1 サービス疎通確認機能の実装
  - Laravel APIエンドポイント疎通確認機能を実装（/api/health）
  - User Appエンドポイント疎通確認機能を実装
  - Admin Appエンドポイント疎通確認機能を実装
  - データベース接続確認機能を実装
  - 疎通確認成功時のログ出力機能を実装
  - 疎通確認失敗時のエラーログとトラブルシューティング表示機能を実装
  - _Requirements: Requirement 4 (検証として統合)_

- [ ] 7.2 セットアップ検証スクリプトの作成
  - セットアップ検証スクリプトファイルを作成
  - サービス疎通確認機能を統合
  - 検証結果サマリー表示機能を実装
  - 検証失敗時のエラーハンドリング機能を実装
  - _Requirements: Requirement 4 (検証として統合)_

- [x] 8. メインオーケストレータースクリプトの実装（完了）
- [x] 8.1 メインスクリプト基本構造の実装
  - メインスクリプトファイルを作成 ✅
  - 共通ライブラリの読み込み機能を実装 ✅
  - コマンドライン引数解析機能の統合 ✅
  - OS検出機能の統合 ✅
  - エラーハンドリング設定機能を実装（set -e） ✅
  - _Requirements: 全体のオーケストレーション_

- [x] 8.2 進捗管理機能の統合
  - 進捗マーカー読み込み機能の統合 ✅
  - 各フェーズ実行前の完了チェック機能の統合 ✅
  - フェーズ完了時の進捗保存機能の統合 ✅
  - セットアップ完了時のマーカーファイル削除機能の統合 ✅
  - _Requirements: 5.1, 5.9, 5.10_

- [x] 8.3 5フェーズ実行機能の実装（簡易版）
  - Phase 1（前提条件チェック）実行機能を実装 ✅
  - Phase 2（環境変数セットアップ）実行機能を実装 ✅
  - Phase 3（依存関係インストール）実行機能を実装 ✅
  - Phase 4（サービス起動・初期化）実行機能を実装 ✅
  - Phase 5（セットアップ検証）実行機能を実装 ✅
  - 各フェーズ間のログ出力と進捗表示機能を実装 ✅
  - _Requirements: 全Requirementの統合実行_

- [x] 8.4 完了サマリー表示機能の実装
  - 全体所要時間表示機能を実装 ✅
  - 各フェーズ所要時間サマリー表示機能を実装 ✅
  - アクセスURLと次のステップガイド表示機能を実装 ✅
  - パフォーマンス警告表示機能の統合（10分超過時） ✅
  - _Requirements: 7.7, 10.1, 10.5_

- [x] 9. Makefileターゲットの追加（完了）
- [x] 9.1 setupターゲットの追加
  - Makefileにsetupターゲットを追加 ✅
  - メインスクリプト呼び出し機能を実装 ✅
  - ターゲットコメント追加機能を実装（## ヘルプ表示用） ✅
  - _Requirements: 全体のエントリポイント_

- [x] 9.2 setup関連ターゲットの追加
  - setup-fromターゲットの追加（部分的再実行用） ✅
  - setup-ciターゲットの追加（CI/CD用） ✅
  - Makefileヘルプ表示への追加 ✅
  - _Requirements: 5.4, 8.1, 8.2, 8.3_

- [x] 10. ドキュメント整備（完了）
- [x] 10.1 README.md更新
  - クイックスタートセクションの追加（make setup実行手順） ✅
  - 前提条件セクションの更新（Docker、Node.js等のバージョン要件） ✅
  - 部分的再実行方法の説明追加（--from <step>） ✅
  - CI/CDモード使用方法の説明追加（--ci） ✅
  - _Requirements: 9.1, 9.2, 9.6, 9.7_

- [ ] 10.2 トラブルシューティングガイドの作成（今後の課題）
  - よくあるエラーパターンと解決方法の記載
  - 環境別問題対処法の記載（macOS/Linux/WSL2）
  - ポート競合対処法の記載
  - ディスク容量不足対処法の記載
  - ネットワークエラー対処法の記載
  - _Requirements: 9.3, 9.4, 9.5_

- [ ] 11. テストとCI/CD統合
- [ ] 11.1 セットアップスクリプトの単体テスト作成
  - OS検出機能のテスト作成
  - 進捗管理機能のテスト作成
  - ログ機能のテスト作成
  - リトライロジックのテスト作成
  - バージョンチェック機能のテスト作成
  - _Requirements: テスト戦略（Unit Tests）_

- [ ] 11.2 セットアップスクリプトの統合テスト作成
  - 前提条件チェックフェーズのテスト作成
  - 環境変数セットアップフェーズのテスト作成
  - 依存関係インストールフェーズのテスト作成
  - サービス起動フェーズのテスト作成
  - セットアップ検証フェーズのテスト作成
  - _Requirements: テスト戦略（Integration Tests）_

- [ ] 11.3 E2Eテストの作成
  - クリーン環境セットアップテストの作成
  - 冪等性テストの作成（2回連続実行）
  - 部分的再実行テストの作成
  - 環境差異テストの作成（macOS/Linux/WSL2）
  - CI/CDモードテストの作成
  - _Requirements: テスト戦略（E2E Tests）_

- [ ] 11.4 パフォーマンステストの作成
  - セットアップ時間測定テストの作成（15分以内）
  - 部分的再実行時間測定テストの作成（2分以内）
  - キャッシュ効果測定テストの作成
  - 並列処理効果測定テストの作成
  - _Requirements: テスト戦略（Performance Tests）、10.1, 10.2, 10.3, 10.4_

- [ ] 11.5 GitHub Actionsワークフローの作成
  - セットアップスクリプトCI/CDワークフローファイル作成
  - 複数OS環境でのテスト実行設定（macOS/Linux）
  - セットアップ成功確認ジョブの追加
  - パフォーマンス測定ジョブの追加
  - テスト結果レポート生成機能の追加
  - _Requirements: 8全体（CI/CD統合）_

- [ ] 12. セットアップスクリプトの統合テストと最終検証
- [ ] 12.1 全環境でのE2Eテスト実行
  - macOS環境でのセットアップ実行とテスト
  - Linux環境でのセットアップ実行とテスト
  - WSL2環境でのセットアップ実行とテスト
  - セットアップ時間測定と15分以内達成確認
  - エラーハンドリングとリトライ動作確認
  - _Requirements: 6.1, 6.2, 6.3, 6.4, 10.1_

- [ ] 12.2 冪等性と部分的再実行の検証
  - セットアップ2回連続実行テスト
  - 既存ファイル保護動作確認
  - 進捗マーカーファイル動作確認
  - 部分的再実行（--from <step>）動作確認
  - 2分以内の部分的再実行時間確認
  - _Requirements: 5.1, 5.4, 5.10, 10.2_

- [ ] 12.3 セキュリティ検証
  - 機密情報マスキング動作確認
  - .gitignoreチェック動作確認
  - ファイルパーミッション設定確認
  - 一時ファイル削除動作確認
  - root権限チェック動作確認
  - _Requirements: 11.1, 11.2, 11.3, 11.4, 11.5_

- [ ] 12.4 CI/CDモード検証
  - GitHub Actions環境でのセットアップ実行テスト
  - 対話的プロンプト無効化確認
  - 終了コード適切設定確認
  - GitHub Actions annotations形式エラー出力確認
  - タイムアウト制御動作確認
  - _Requirements: 8.1, 8.2, 8.3, 8.4, 8.5, 8.6_

- [ ] 12.5 パフォーマンス最終検証
  - クリーン環境セットアップ時間測定（15分以内目標）
  - 部分的再実行時間測定（2分以内目標）
  - 各フェーズ所要時間分析とボトルネック特定
  - キャッシュ効果検証（Composer、npm、Docker）
  - 並列処理効果検証（Docker image pull）
  - _Requirements: 10.1, 10.2, 10.3, 10.4, 10.5_

- [ ] 12.6 ドキュメント最終確認
  - README.mdのセットアップ手順検証
  - トラブルシューティングガイドの内容検証
  - コマンドライン引数の説明確認
  - エラーメッセージとガイドの内容確認
  - チーム内レビューとフィードバック収集
  - _Requirements: 9.1, 9.2, 9.3, 9.4, 9.5, 9.6, 9.7_
