# 実装タスク

## タスク概要

本タスクリストは、フロントエンドCI/CDパイプラインにTypeScript型チェックと本番ビルド検証を追加する実装計画を定義します。既存のlint/testジョブと並列実行する新しいbuildジョブを追加することで、PR時点でビルドエラーを早期検出し、Issue #124のような本番デプロイ直前でのビルドエラー発見を防止します。

**実装範囲**: `.github/workflows/frontend-test.yml`に新しいbuildジョブを追加（既存ジョブは変更なし）

**対象アプリ**: Admin App、User App（Matrix戦略により並列検証）

---

## タスク 1: CI/CDワークフロー基盤構成

既存のfrontend-test.ymlワークフローに新しいbuildジョブを追加し、lint/testジョブと並列実行できる基盤を構築します。Matrix戦略によりAdmin AppとUser Appを並列検証し、CI/CD全体の実行時間を最小化します。

### タスク 1.1: buildジョブのMatrix戦略設定

Admin AppとUser Appを並列検証するためのMatrix戦略を設定し、既存のlint/testジョブと同じ並列実行パターンを実現します。

**実施内容**:
- 新しいbuildジョブをfrontend-test.ymlに追加する
- Matrix戦略で`matrix.app: [admin-app, user-app]`を設定し、2つのアプリを並列実行可能にする
- Node.jsバージョンを`matrix.node-version: [20.x]`に固定する
- `fail-fast: false`を設定し、一つのアプリの失敗が他のアプリの検証を中断しないようにする
- ランナー環境を`runs-on: ubuntu-latest`に設定する
- 既存のlint/testジョブのMatrix戦略設定を参考にし、構成の一貫性を保つ

_Requirements: 3.5, 4.1, 4.2_

### タスク 1.2: Node.js環境セットアップステップの追加

TypeScript型チェックと本番ビルド実行に必要なNode.js環境とnpm依存関係を自動構成します。

**実施内容**:
- `actions/checkout@v4`によるコードチェックアウトステップを追加する
- `actions/setup-node@v4`によるNode.js 20.xセットアップステップを追加する
- npmキャッシュを有効化（`cache: 'npm'`）し、依存関係インストール時間を80%以上短縮する
- `npm ci`コマンドによる依存関係の厳密インストールステップを追加する
- 既存のlint/testジョブと同じステップ構成を採用し、保守性を向上させる

_Requirements: 3.2, 3.3_

### タスク 1.3: CI環境変数の自動構成

フロントエンドビルドに必要な環境変数ファイルを自動生成し、環境変数バリデーションを実行します。

**実施内容**:
- `.env.example`から`.env`ファイルを自動生成するステップを追加する
- `backend/laravel-api/.env.example`から`backend/laravel-api/.env`を自動生成するステップを追加する
- `npm run env:check`による環境変数バリデーションステップを追加する
- `CI=true`環境変数を設定し、CI環境に最適化されたビルドプロセスを有効化する
- 環境変数ファイル生成失敗時に明確なエラーメッセージを出力する仕組みを設定する

_Requirements: 3.1, 3.4_

---

## タスク 2: TypeScript型チェック統合

PR作成時にTypeScript型エラーを自動検知し、型安全性を保証する型チェックステップを実装します。型エラーが検出された場合、高コストな本番ビルドステップをスキップしてCI/CDリソースを節約します。

### タスク 2.1: TypeScript型チェック実行ステップの実装

各アプリディレクトリでTypeScript型チェックを実行し、型エラーを検出します。

**実施内容**:
- `npm run type-check`を実行するステップをbuildジョブに追加する
- `working-directory: frontend/${{ matrix.app }}`を設定し、各アプリディレクトリで独立して型チェックを実行する
- `npx tsc --noEmit`による型エラーのみの検証を実現する（JavaScriptファイルを生成しない）
- 型チェックステップの実行順序を、環境変数バリデーション後、本番ビルド前に配置する
- 型チェック失敗時に詳細なエラーメッセージがGitHub Actionsログに出力されることを確認する

_Requirements: 1.1, 1.2, 1.6_

### タスク 2.2: TypeScript型エラー検出時のPRマージブロック

型エラーが検出された場合、CI/CDパイプラインを失敗させ、PRマージを自動的にブロックします。

**実施内容**:
- 型チェックステップの終了コードが非ゼロの場合、ジョブを失敗させる設定を確認する
- GitHub PRステータスチェックに型チェック結果が反映されることを確認する
- 型エラー検出時にPRマージボタンが無効化されることを確認する
- 型エラーの詳細がPRページから簡単にアクセスできることを確認する

_Requirements: 1.3, 1.4_

---

## タスク 3: 本番ビルド検証統合

PR作成時にNext.js本番ビルドが成功することを自動検証し、ビルドエラーを早期検出します。レイアウト構造問題や環境変数不足などのビルドエラーをPR時点で発見します。

### タスク 3.1: 本番ビルド実行ステップの実装

各アプリディレクトリでNext.js本番ビルドを実行し、ビルドエラーを検出します。

**実施内容**:
- `npm run build`を実行するステップをbuildジョブに追加する
- `working-directory: frontend/${{ matrix.app }}`を設定し、各アプリディレクトリで独立してビルドを実行する
- `CI=true`環境変数を設定し、CI環境に最適化されたビルドプロセスを実行する
- ビルドステップの実行順序を、TypeScript型チェック成功後に配置する
- Next.js本番最適化（minification, tree-shaking, output file tracing）を含む完全なビルドプロセスが実行されることを確認する

_Requirements: 2.1, 2.2, 2.6_

### タスク 3.2: 本番ビルドエラー検出時のPRマージブロック

ビルドエラーが検出された場合、CI/CDパイプラインを失敗させ、PRマージを自動的にブロックします。

**実施内容**:
- ビルドステップの終了コードが非ゼロの場合、ジョブを失敗させる設定を確認する
- ビルドエラー（レイアウト構造問題、環境変数不足、モジュール未検出等）が検出された場合、PRマージがブロックされることを確認する
- GitHub PRステータスチェックにビルド結果が反映されることを確認する
- ビルドエラーの詳細がPRページから簡単にアクセスできることを確認する

_Requirements: 2.3, 2.4, 2.5_

---

## タスク 4: 既存CI/CDワークフローとの統合

新しいbuildジョブが既存のlint/testジョブと連携して動作し、包括的な品質ゲートを実現します。lint/test/buildの3つのジョブ全てが成功した場合のみ、PRマージを許可します。

### タスク 4.1: 並列実行とステータスチェック統合の確認

lint/test/buildの3つのジョブが並列実行され、全てのステータスがPRに正しく報告されることを確認します。

**実施内容**:
- buildジョブがlint/testジョブと独立して並列実行されることを確認する
- GitHub PRステータスチェックに3つのジョブ（lint、test、build）が表示されることを確認する
- いずれかのジョブが失敗した場合、PRステータスチェック全体が失敗を表示することを確認する
- 全てのジョブが成功した場合、PRステータスチェックが緑色で表示され、マージ可能状態となることを確認する
- 既存のconcurrency設定により、同一PR内の古いワークフロー実行が自動キャンセルされることを確認する

_Requirements: 5.1, 5.2, 5.3, 5.4_

### タスク 4.2: 既存ステップ構成の再利用確認

buildジョブが既存のlint/testジョブのステップ構成を再利用し、保守性が向上していることを確認します。

**実施内容**:
- buildジョブのcheckout、setup-node、npm ci、.env生成、env:checkステップが既存ジョブと同じ構成であることを確認する
- Matrix戦略の設定が既存ジョブと一貫性を持つことを確認する
- GitHub Actions公式アクションのバージョン（@v4）が既存ジョブと統一されていることを確認する
- buildジョブの追加が既存のlint/testジョブに影響を与えないことを確認する

_Requirements: 5.5_

---

## タスク 5: 検証とテスト

実装されたbuildジョブが要件を満たし、期待通り動作することを包括的に検証します。正常系・異常系テストを実施し、本番適用前の品質を保証します。

### タスク 5.1: YAML構文とMatrix戦略の検証

frontend-test.ymlのYAML構文が正しく、Matrix戦略が期待通り展開されることを検証します。

**実施内容**:
- `yamllint`または`actionlint`によりfrontend-test.ymlの構文エラーを検出する
- Matrix戦略が正しく展開され、admin-app/user-appの2つのジョブが生成されることを確認する
- 環境変数が正しく設定されていることを確認する
- ローカル実行ツール（`act`等）を使用し、ワークフローがローカルで期待通り動作することを確認する

_Requirements: 全般_

### タスク 5.2: 正常系統合テストの実施

型エラーなし、ビルド成功のPRを作成し、CI/CD全ジョブが成功することを確認します。

**実施内容**:
- 既存のコードに影響しない軽微な変更（READMEの更新等）を含むPRを作成する
- frontend-test.ymlワークフローが自動的にトリガーされることを確認する
- buildジョブ（admin-app, user-app）が並列実行されることを確認する
- TypeScript型チェックステップが成功することを確認する
- 本番ビルドステップが成功することを確認する
- lint/test/buildの3つのジョブ全てが成功し、PRステータスチェックが緑色で表示されることを確認する
- PRマージが可能であることを確認する

_Requirements: 全般_

### タスク 5.3: TypeScript型エラー検出の異常系テスト

意図的に型エラーを含むコードをPRに含め、buildジョブが失敗し、PRマージがブロックされることを確認します。

**実施内容**:
- Admin AppまたはUser Appに意図的な型エラー（例: `const x: number = "string"`）を含むPRを作成する
- TypeScript型チェックステップが失敗することを確認する
- 本番ビルドステップがスキップされることを確認する（型チェック失敗により後続ステップが実行されない）
- buildジョブが失敗ステータスを返すことを確認する
- PRステータスチェックが失敗を表示し、マージボタンが無効化されることを確認する
- 型エラーの詳細がGitHub Actionsログに出力されることを確認する

_Requirements: 1.3, 1.4_

### タスク 5.4: 本番ビルドエラー検出の異常系テスト

レイアウト構造問題を含むコードをPRに含め、buildジョブが失敗し、PRマージがブロックされることを確認します。

**実施内容**:
- Admin AppまたはUser Appに意図的なレイアウト構造問題（例: Issue #124で発生したsimple-error-test問題）を含むPRを作成する
- TypeScript型チェックステップが成功することを確認する
- 本番ビルドステップが失敗することを確認する
- buildジョブが失敗ステータスを返すことを確認する
- PRステータスチェックが失敗を表示し、マージボタンが無効化されることを確認する
- ビルドエラーの詳細がGitHub Actionsログに出力されることを確認する

_Requirements: 2.3, 2.4_

### タスク 5.5: Matrix並列実行確認テスト

Admin AppとUser App両方を変更したPRを作成し、Matrix戦略により並列実行され、両方の結果が報告されることを確認します。

**実施内容**:
- Admin AppとUser App両方に変更を含むPRを作成する
- buildジョブがMatrix戦略により2つのジョブ（admin-app, user-app）に展開されることを確認する
- 2つのジョブが並列実行されることを確認する（GitHub Actionsログのタイムスタンプで確認）
- `fail-fast: false`設定により、一方のアプリが失敗しても他方の検証が継続されることを確認する
- 両方のアプリの結果がPRステータスチェックに表示されることを確認する

_Requirements: 4.1, 4.2, 4.3_

### タスク 5.6: 既存ジョブとの連携確認テスト

lint失敗、test成功、build成功のPRを作成し、PRステータスチェック全体が失敗表示されることを確認します。

**実施内容**:
- 意図的にESLintエラーを含むコードをPRに含める（型エラーなし、ビルド成功）
- lintジョブが失敗することを確認する
- testジョブとbuildジョブが成功することを確認する
- PRステータスチェック全体が失敗を表示し、マージがブロックされることを確認する
- lint/test/buildのいずれかが失敗した場合、PRマージが不可能であることを確認する

_Requirements: 5.2_

---

## タスク 6: 本番適用とドキュメント整備

検証が完了したbuildジョブをmainブランチにマージし、本番適用します。CI/CD変更をチームに通知し、継続的な監視・最適化を実施します。

### タスク 6.1: 本番環境への適用

検証済みのbuildジョブをmainブランチにマージし、全てのPRでbuildジョブが実行されるようにします。

**実施内容**:
- frontend-test.yml変更を含むPRをmainブランチにマージする
- マージ後、新しいPRを作成し、buildジョブが自動的に実行されることを確認する
- ブランチプロテクションルールにbuildジョブを追加することを検討する（オプション）
- チーム全体にCI/CD変更を通知する（Slackやメール等）
- 本機能の目的（ビルドエラーのPR時検知）と使い方を説明する

_Requirements: 全般_

### タスク 6.2: 継続的な監視と最適化

CI/CD実行時間とbuildジョブの失敗率を監視し、必要に応じて最適化を実施します。

**実施内容**:
- GitHub Actions Usage Insightsでbuildジョブの実行時間を監視する（目標: 5-10分/アプリ）
- CI/CD全体の実行時間を監視する（目標: 10-15分、lint/test/build並列実行）
- buildジョブの失敗率を追跡し、誤検知の有無を確認する（目標: 誤検知<5%）
- npmキャッシュのヒット率を確認する（目標: 80%以上）
- 実行時間が目標を超過する場合、Next.jsビルドキャッシュ導入を検討する
- ロールバックトリガー（誤検知頻発、実行時間2倍超過等）に該当する問題が発生していないことを確認する

_Requirements: 全般_

---

## 完了基準

### Phase 1完了基準（タスク1-4完了時）
- [ ] buildジョブがfrontend-test.ymlに追加されている
- [ ] YAML構文エラーがない（yamllint/actionlint検証済み）
- [ ] Matrix戦略が正しく設定されている（admin-app, user-app並列実行）
- [ ] TypeScript型チェックステップが実装されている
- [ ] 本番ビルドステップが実装されている
- [ ] 既存のlint/testジョブに影響がない

### Phase 2完了基準（タスク5完了時）
- [ ] 正常系テスト成功（型エラーなし、ビルド成功のPRでCI/CD成功）
- [ ] TypeScript型エラー検出テスト成功（型エラー含むPRでbuildジョブ失敗）
- [ ] 本番ビルドエラー検出テスト成功（レイアウト問題含むPRでbuildジョブ失敗）
- [ ] 並列実行確認テスト成功（admin-app/user-app両方の結果が報告される）
- [ ] 既存ジョブとの連携テスト成功（lint/test/buildいずれか失敗でPRマージブロック）

### Phase 3完了基準（タスク6.1完了時）
- [ ] mainブランチにマージ完了
- [ ] 全てのPRでbuildジョブが自動実行される
- [ ] チームへの通知完了
- [ ] ブランチプロテクションルール更新（オプション）

### Phase 4継続基準（タスク6.2継続中）
- [ ] CI/CD実行時間が目標範囲内（10-15分）
- [ ] buildジョブの失敗率が許容範囲内（誤検知<5%）
- [ ] GitHub Actions使用量が予算内
- [ ] ロールバックトリガーに該当する問題が発生していない

---

## 推定工数

- **タスク 1**: 3時間（YAML設定変更、環境変数セットアップ）
- **タスク 2**: 2時間（型チェックステップ実装、エラーハンドリング確認）
- **タスク 3**: 2時間（ビルドステップ実装、エラーハンドリング確認）
- **タスク 4**: 2時間（既存ジョブとの統合確認、並列実行検証）
- **タスク 5**: 6時間（YAML検証、正常系テスト、異常系テスト3種、並列実行確認、連携確認）
- **タスク 6**: 2時間（本番適用、チーム通知、監視設定）

**合計推定工数**: 17時間（約2-3営業日）

---

## 依存関係

- **タスク 1 → タスク 2**: buildジョブ基盤が構築された後、型チェックステップを追加
- **タスク 2 → タスク 3**: 型チェックステップが完了した後、ビルドステップを追加（型チェック → ビルドの順次実行）
- **タスク 3 → タスク 4**: ビルドステップが完了した後、既存ジョブとの統合を確認
- **タスク 4 → タスク 5**: 統合が完了した後、包括的な検証テストを実施
- **タスク 5 → タスク 6**: 検証テストが成功した後、本番適用とドキュメント整備を実施

---

## リスクと軽減策

### リスク 1: CI/CD実行時間の増加
- **影響**: buildジョブ追加によりCI/CD全体の実行時間が増加し、開発フィードバックループが遅延する可能性
- **軽減策**: lint/test/buildジョブを並列実行することで、実行時間への影響を最小化。npmキャッシュ有効化により依存関係インストール時間を80%以上短縮。
- **対応**: Phase 4でCI/CD実行時間を監視し、目標（10-15分）を超過する場合はNext.jsビルドキャッシュ導入を検討。

### リスク 2: buildジョブの誤検知
- **影響**: 正常なコードに対してbuildジョブが失敗し、開発者の生産性が低下する可能性
- **軽減策**: 既存の`npm run type-check`と`npm run build`スクリプトを使用し、ローカル環境と同じ検証ロジックを採用。検証テスト（タスク5）で誤検知がないことを事前確認。
- **対応**: Phase 4でbuildジョブの失敗率を追跡し、誤検知が頻発（週3回以上）する場合はロールバックを検討。

### リスク 3: 既存のlint/testジョブへの影響
- **影響**: buildジョブ追加により既存ジョブが予期しない動作をする可能性
- **軽減策**: buildジョブを独立したジョブとして実装し、既存ジョブのYAML設定を変更しない。検証テスト（タスク5.6）で既存ジョブとの連携を確認。
- **対応**: Phase 2でlint/test/buildの全てのジョブが正しく動作することを確認。問題が発生した場合はロールバック。

### リスク 4: GitHub Actions実行制限への到達
- **影響**: buildジョブ追加によりGitHub Actionsの月間実行制限に到達する可能性
- **軽減策**: 並列実行により実時間を最小化。既存のconcurrency設定により不要なワークフロー実行を自動キャンセル。
- **対応**: Phase 4でGitHub Actions使用量を監視し、予算超過の兆候がある場合は実行頻度を調整（pathsフィルター最適化等）。

---

## 関連ドキュメント

- [要件定義書](./requirements.md) - 5つの主要要件と26の受入基準
- [技術設計書](./design.md) - アーキテクチャ、フロー、コンポーネント詳細
- [GitHub Issue #127](https://github.com/ef-tech/laravel-next-b2c/issues/127) - 元のIssue（フロントエンド本番ビルドステップ欠落）
- [GitHub Issue #124](https://github.com/ef-tech/laravel-next-b2c/issues/124) - 関連Issue（Admin App本番ビルド失敗）
- `.github/workflows/frontend-test.yml` - 修正対象ファイル
