# 実装計画

## 概要

Docker Compose環境におけるNext.jsアプリケーション（Admin App / User App）にヘルスチェック機能を追加し、E2Eテストサービスの起動タイミングを最適化する。本実装では、Alpine Linux標準ツール（wget）のみを使用し、既存のDocker構成に対して非破壊的な拡張を行う。

## 実装タスク

- [ ] 1. Admin Appヘルスチェックエンドポイント実装
- [ ] 1.1 Admin Appヘルスチェック用API Routeファイル作成
  - Next.js App Router規約に従い、ヘルスチェック専用エンドポイントディレクトリを作成
  - GETリクエストハンドラを実装し、HTTPステータス200と固定JSONレスポンスを返す機能を追加
  - エンドポイントがステートレスで外部依存なしで動作することを保証
  - レスポンス形式を `{"status": "ok"}` に統一
  - _Requirements: 1.1, 1.2_

- [ ] 1.2 Admin Appヘルスチェックエンドポイント単体テスト作成
  - Jestテストファイルを作成し、ヘルスチェックエンドポイントの動作を検証
  - HTTPステータス200応答を確認するテストケース実装
  - レスポンスボディが期待される形式であることを確認するテストケース実装
  - 認証不要でアクセス可能であることを検証
  - 冪等性（何度実行しても同じ結果）を確認するテストケース実装
  - _Requirements: 1.1, 1.2_

- [ ] 2. User Appヘルスチェックエンドポイント実装
- [ ] 2.1 User Appヘルスチェック用API Routeファイル作成
  - Admin Appと同様の構造でヘルスチェックエンドポイントを作成
  - GETリクエストハンドラを実装し、Admin Appと同一のレスポンス形式を返す
  - エンドポイントがステートレスで外部依存なしで動作することを保証
  - _Requirements: 2.1, 2.2_

- [ ] 2.2 User Appヘルスチェックエンドポイント単体テスト作成
  - Admin Appと同様のテストスイートを作成
  - HTTPステータス200応答を確認するテストケース実装
  - レスポンスボディ検証テストケース実装
  - 認証不要アクセス検証と冪等性確認テストケース実装
  - _Requirements: 2.1, 2.2_

- [ ] 3. Admin App Dockerfileヘルスチェック設定追加
- [ ] 3.1 Admin App DockerfileにHEALTHCHECKディレクティブ追加
  - runnerステージにHEALTHCHECKディレクティブを追加
  - wgetコマンドを使用したヘルスチェックコマンドを設定（--spider, --no-verbose, --tries=1オプション使用）
  - ヘルスチェック間隔を10秒、タイムアウトを3秒、起動猶予期間を30秒、リトライ回数を3回に設定
  - ローカルホスト（localhost）のポート13002に対して `/api/health` エンドポイントへアクセス
  - 失敗時に終了コード1を返すエラーハンドリング追加
  - _Requirements: 1.3, 1.4, 1.5, 1.6, 1.7, 6.1, 6.2, 6.3, 6.4, 6.5_

- [ ] 4. User App Dockerfileヘルスチェック設定追加
- [ ] 4.1 User App DockerfileにHEALTHCHECKディレクティブ追加
  - Admin Appと同様にrunnerステージにHEALTHCHECKディレクティブを追加
  - wgetコマンドを使用したヘルスチェックコマンドを設定（同一オプション構成）
  - ヘルスチェックパラメータをAdmin Appと同一に設定（間隔、タイムアウト、猶予期間、リトライ）
  - ローカルホストのポート13001に対して `/api/health` エンドポイントへアクセス
  - 失敗時のエラーハンドリング追加
  - _Requirements: 2.3, 2.4, 2.5, 2.6, 2.7, 6.1, 6.2, 6.3, 6.4, 6.5_

- [ ] 5. Docker Composeサービス依存関係最適化
- [ ] 5.1 docker-compose.ymlのe2e-testsサービス定義更新
  - E2Eテストサービスの `depends_on` 設定を拡張
  - Admin Appに対して `condition: service_healthy` を指定
  - User Appに対して `condition: service_healthy` を指定
  - Laravel APIは既存の起動完了確認のまま維持（`condition: service_started`）
  - 既存のサービス定義との後方互換性を維持
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5_

- [ ] 6. Dockerヘルスチェック統合テスト実装
- [ ] 6.1 Admin App Dockerヘルスチェック動作検証スクリプト作成
  - Docker Composeを使用してAdmin Appコンテナを起動
  - 起動猶予期間（30秒）経過後にhealthyステータスになることを検証
  - `docker inspect` コマンドでヘルスステータスを確認するロジック実装
  - ヘルスチェック履歴（最新5件）の取得と検証
  - テスト成功時のクリーンアップ処理追加
  - _Requirements: 1.3, 1.4, 1.5, 1.6_

- [ ] 6.2 User App Dockerヘルスチェック動作検証スクリプト作成
  - Admin Appと同様の検証スクリプトをUser App向けに作成
  - 起動猶予期間後のhealthyステータス検証
  - ヘルスステータス確認とヘルスチェック履歴取得
  - テストクリーンアップ処理追加
  - _Requirements: 2.3, 2.4, 2.5, 2.6_

- [ ] 6.3 unhealthyステータス検出テスト実装
  - ヘルスチェックエンドポイントが存在しない状態でコンテナ起動
  - 3回連続失敗後にunhealthyステータスに変更されることを検証
  - unhealthy検出までの時間測定（最大40秒以内）
  - エラーログ出力の確認
  - _Requirements: 1.6, 2.6_

- [ ] 7. E2Eサービス依存関係テスト実装
- [ ] 7.1 E2Eテストサービス起動タイミング検証テスト作成
  - Docker Compose全サービス起動テストスクリプト作成
  - Admin AppとUser Appがhealthy状態になるまでE2Eテストサービスが待機することを検証
  - 全依存サービスhealthy後にE2Eテストサービスが起動することを確認
  - 起動タイミングのログ記録と分析
  - _Requirements: 3.1, 3.2, 3.4_

- [ ] 7.2 unhealthy状態でのE2Eテストサービス起動防止検証
  - Admin AppまたはUser Appがunhealthy状態の場合のテストケース作成
  - E2Eテストサービスが起動しないことを確認
  - unhealthy状態の検出とログ確認
  - _Requirements: 3.3_

- [ ] 7.3 ヘルスチェック可視化検証
  - `docker compose ps` コマンド出力のパース処理実装
  - Admin AppとUser Appのステータスに `(healthy)` または `(unhealthy)` が表示されることを確認
  - ステータス表示フォーマット検証（`Up X seconds (healthy)` 形式）
  - _Requirements: 4.1, 4.2, 4.3, 4.4_

- [ ] 8. 既存E2Eテストへの影響検証
- [ ] 8.1 既存E2Eテストのリグレッションテスト実行
  - 既存のE2Eテストスイート（Playwright）を全て実行
  - Connection refusedエラーが発生しないことを確認
  - テスト成功率が100%であることを検証
  - _Requirements: 5.1, 5.2_

- [ ] 8.2 E2Eテスト実行時間への影響測定
  - ヘルスチェック追加前後のE2Eテスト実行時間を比較
  - healthy待機時間のオーバーヘッドを測定（許容範囲: +10秒以内）
  - 並列実行（4 Shard）での実行時間確認
  - _Requirements: 5.4_

- [ ] 9. パフォーマンステスト実装
- [ ] 9.1 ヘルスチェックエンドポイント応答時間測定
  - `/api/health` エンドポイントへの連続リクエスト送信テスト作成
  - 平均応答時間が3秒以内（目標: 10ms以内）であることを確認
  - 応答時間の統計情報取得（最小、最大、平均、中央値）
  - _Requirements: 非機能要件（パフォーマンス）_

- [ ] 9.2 ヘルスチェック処理のリソース影響測定
  - `docker stats` コマンドを使用したCPU/メモリ使用率モニタリング
  - ヘルスチェック実行前後のリソース使用率差分計算
  - CPU使用率増加が1%未満、メモリ使用率増加が1%未満であることを確認
  - 長時間安定動作テスト（1時間以上連続実行）
  - _Requirements: 5.3, 5.4, 非機能要件（パフォーマンス）_

- [ ] 9.3 複数コンテナ同時ヘルスチェックの負荷テスト
  - Admin AppとUser Appの同時ヘルスチェック実行時のリソース影響測定
  - E2E並列実行（4 Shard）時のヘルスチェック安定性検証
  - リソース競合がないことを確認
  - _Requirements: 非機能要件（パフォーマンス、信頼性）_

- [ ] 10. ドキュメント更新と統合テスト完了
- [ ] 10.1 全テストスイートの実行と検証
  - ユニットテスト（Jest）の実行と成功確認
  - 統合テスト（Dockerヘルスチェック）の実行と成功確認
  - E2Eテスト（Playwright）の実行と成功確認
  - パフォーマンステストの実行と目標達成確認
  - 全テストスイートが成功することを最終検証
  - _Requirements: 全要件（成功基準確認）_

- [ ] 10.2 実装完了確認とクリーンアップ
  - 全ての要件が実装されていることを最終確認
  - 後方互換性維持の検証（既存起動コマンドの動作確認）
  - Connection refusedエラー発生頻度0%達成の確認
  - テスト環境のクリーンアップ
  - 実装レビュー準備（コード品質、テストカバレッジ確認）
  - _Requirements: 5.1, 5.2, 成功基準1, 成功基準5_

## 要件カバレッジマトリクス

| 要件 | 対応タスク |
|------|----------|
| 要件1.1 - Admin App `/api/health` 提供 | 1.1 |
| 要件1.2 - Admin App HTTPステータス200応答 | 1.1, 1.2 |
| 要件1.3 - Admin App 10秒間隔ヘルスチェック | 3.1, 6.1 |
| 要件1.4 - Admin App 3秒タイムアウト | 3.1, 6.1 |
| 要件1.5 - Admin App 30秒起動猶予期間 | 3.1, 6.1 |
| 要件1.6 - Admin App 3回連続失敗でunhealthy | 3.1, 6.3 |
| 要件1.7 - Admin App wget --spiderコマンド使用 | 3.1 |
| 要件2.1 - User App `/api/health` 提供 | 2.1 |
| 要件2.2 - User App HTTPステータス200応答 | 2.1, 2.2 |
| 要件2.3 - User App 10秒間隔ヘルスチェック | 4.1, 6.2 |
| 要件2.4 - User App 3秒タイムアウト | 4.1, 6.2 |
| 要件2.5 - User App 30秒起動猶予期間 | 4.1, 6.2 |
| 要件2.6 - User App 3回連続失敗でunhealthy | 4.1, 6.3 |
| 要件2.7 - User App wget --spiderコマンド使用 | 4.1 |
| 要件3.1 - E2E Admin App healthy待機 | 5.1, 7.1 |
| 要件3.2 - E2E User App healthy待機 | 5.1, 7.1 |
| 要件3.3 - unhealthy時E2E起動停止 | 7.2 |
| 要件3.4 - 両方healthy後E2E起動 | 5.1, 7.1 |
| 要件3.5 - depends_on service_healthy指定 | 5.1 |
| 要件4.1 - Admin App healthyステータス表示 | 7.3 |
| 要件4.2 - User App healthyステータス表示 | 7.3 |
| 要件4.3 - healthy時表示フォーマット | 7.3 |
| 要件4.4 - unhealthy時表示フォーマット | 7.3 |
| 要件5.1 - 既存起動コマンド維持 | 8.1, 10.2 |
| 要件5.2 - 既存機能影響なし | 8.1, 10.2 |
| 要件5.3 - 軽量処理（wgetヘッダー確認） | 9.2 |
| 要件5.4 - パフォーマンス影響最小限 | 8.2, 9.2 |
| 要件6.1 - Alpine Linux wget使用 | 3.1, 4.1 |
| 要件6.2 - --spiderオプション使用 | 3.1, 4.1 |
| 要件6.3 - HTTPヘッダー確認のみ | 3.1, 4.1 |
| 要件6.4 - 成功時終了コード0 | 3.1, 4.1, 6.1, 6.2 |
| 要件6.5 - 失敗時終了コード1 | 3.1, 4.1, 6.3 |

## 実装順序の根拠

1. **タスク1-2**: エンドポイント実装とテストを先行実施し、ヘルスチェックの基盤を確立
2. **タスク3-4**: Dockerfileヘルスチェック設定を追加し、コンテナレベルの健全性確認を実装
3. **タスク5**: Docker Composeサービス依存関係を最適化し、E2Eテスト起動制御を実現
4. **タスク6-7**: 統合テストとE2Eテストで全体動作を検証
5. **タスク8-9**: リグレッションテストとパフォーマンステストで品質保証
6. **タスク10**: 最終検証と完了確認

この順序により、各機能が段階的に統合され、問題の早期発見と修正が可能になる。
