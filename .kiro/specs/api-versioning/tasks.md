# 実装タスク計画

## 概要

本タスク計画は、APIバージョニング機能（V1実装）の実装手順を定義します。DDD/クリーンアーキテクチャの4層構造を維持しながら、URLベースバージョニング（`/api/v1`）を導入し、既存のAPIエンドポイントをV1として明示的にバージョン管理します。

**実装フェーズ**: 7フェーズ、合計30タスク

---

## Phase 1: 基盤構築

- [x] 1. 設定ファイルとミドルウェア基盤を構築する
- [x] 1.1 バージョン管理設定ファイルを作成する
  - バージョン管理用の設定ファイルを新規作成
  - デフォルトバージョンとサポート対象バージョンリストを定義
  - バージョン別設定（将来のV2実装用）の構造を準備
  - 環境変数によるデフォルトバージョン指定機能を実装
  - _Requirements: 5.5, 10.4_

- [x] 1.2 APIバージョン判定ミドルウェアを実装する
  - リクエストURLから正規表現でバージョン番号を抽出する機能を実装
  - 抽出したバージョン番号をリクエスト属性に保存する機能を実装
  - サポート対象バージョンリストとの照合処理を実装
  - サポート外バージョンへの404レスポンス処理を実装
  - デフォルトバージョン適用ロジックを実装
  - レスポンスヘッダーにバージョン情報を付与する機能を実装
  - _Requirements: 1.1, 1.2, 1.5, 1.6, 5.1-5.6_

- [x] 1.3 ルートサービスプロバイダーを更新する
  - V1ルーティングファイルのロード機能を追加
  - V1ルートへのプレフィックス自動付与機能を設定
  - V1ルートへのミドルウェアグループ継承設定を追加
  - ルート名にバージョンプレフィックス付与機能を設定
  - _Requirements: 6.1, 6.2, 6.3, 6.6_

- [x] 1.4 ミドルウェア基盤のテストを作成する
  - バージョン抽出機能のテストケースを作成
  - デフォルトバージョン適用のテストケースを作成
  - サポート外バージョンへの404レスポンステストケースを作成
  - レスポンスヘッダー付与のテストケースを作成
  - リクエスト属性保存のテストケースを作成
  - _Requirements: 8.1_

---

## Phase 2: V1コントローラー移行

- [x] 2. 既存コントローラーをV1ディレクトリに移行する
- [x] 2.1 ヘルスチェック機能をV1ディレクトリに移行する
  - ヘルスチェックコントローラーをV1ディレクトリへコピー移動
  - 名前空間をV1コントローラー用に更新
  - ヘルスチェックレスポンス形式を保持
  - ヘルスチェックエンドポイントのテストケースを作成
  - _Requirements: 2.1, 2.2, 2.5_

- [x] 2.2 認証機能をV1ディレクトリに移行する
  - ログイン・ログアウトコントローラーをV1ディレクトリへコピー移動
  - 名前空間をV1コントローラー用に更新
  - 認証レスポンス形式を保持
  - 既存のユースケース呼び出しロジックを維持
  - 認証エンドポイントのテストケースを作成
  - _Requirements: 2.1, 2.2, 2.3, 2.5_

- [x] 2.3 ユーザー情報取得機能をV1ディレクトリに移行する
  - 認証ユーザー情報取得コントローラーをV1ディレクトリへコピー移動
  - 名前空間をV1コントローラー用に更新
  - ユーザー情報レスポンス形式を保持
  - ユーザー情報取得エンドポイントのテストケースを作成
  - _Requirements: 2.1, 2.2, 2.5_

- [x] 2.4 トークン管理機能をV1ディレクトリに移行する
  - トークン管理コントローラーをV1ディレクトリへコピー移動
  - 名前空間をV1コントローラー用に更新
  - トークンレスポンス形式を保持
  - トークン管理エンドポイントのテストケースを作成
  - _Requirements: 2.1, 2.2, 2.5_

- [x] 2.5 CSP違反レポート機能をV1ディレクトリに移行する
  - CSP違反レポートコントローラーをV1ディレクトリへコピー移動
  - 名前空間をV1コントローラー用に更新
  - CSP違反レポートレスポンス形式を保持
  - CSP違反レポートエンドポイントのテストケースを作成
  - _Requirements: 2.1, 2.2, 2.5_

- [x] 2.6 既存テストの回帰確認を実施する
  - 全V1エンドポイントの既存Feature Testsを実行
  - V1エンドポイントのレスポンス形式・HTTPステータスコード・ヘッダーを検証
  - 既存のユースケース呼び出しが正常に動作することを確認
  - _Requirements: 2.4_

---

## Phase 3: Presenter/Request分離

- [x] 3. DDD Infrastructure層のV1 Presenter/Requestを実装する
- [x] 3.1 V1 Presenterを実装する
  - ユーザー情報レスポンス変換Presenterを実装
  - トークン情報レスポンス変換Presenterを実装
  - ヘルスチェックレスポンス変換Presenterを実装
  - Application層DTOからV1レスポンス形式への変換ロジックを実装
  - Presenter変換機能のテストケースを作成
  - _Requirements: 3.4, 3.5_

- [x] 3.2 V1 Requestを実装する
  - ログインリクエストバリデーションを実装
  - ユーザー登録リクエストバリデーションを実装
  - CSP違反レポートリクエストバリデーションを実装
  - V1バリデーションルールとカスタムエラーメッセージを定義
  - Requestバリデーション機能のテストケースを作成
  - _Requirements: 3.5_

- [x] 3.3 DDD層統合テストを実施する（既存Featureテストでカバー済み）
  - V1コントローラーからユースケースへの連携を検証
  - ユースケースOutputのV1レスポンス形式変換を検証
  - V1 Requestバリデーションルールの適用を検証
  - _Requirements: 3.2_

- [x] 3.4 Architecture Testsを作成する
  - Domain層のバージョン固有クラス非依存を検証するテストを作成
  - Application層のバージョン固有クラス非依存を検証するテストを作成
  - V1コントローラーの名前空間配置を検証するテストを作成
  - V1 Presenter/Requestの名前空間配置を検証するテストを作成
  - 依存方向違反ゼロを確認するテストを作成
  - _Requirements: 3.1, 3.6, 3.7, 8.3_

---

## Phase 4: ルーティング統合

- [x] 4. V1ルーティングファイルを作成し、既存ルートと統合する
- [x] 4.1 V1ルーティングファイルを作成する
  - V1エンドポイントのルート定義ファイルを新規作成
  - 全V1エンドポイント（health, login, logout, me, tokens, csp-report）のルートを定義
  - V1ルートにミドルウェアグループ設定を適用
  - V1ルート名にバージョンプレフィックスを付与
  - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.6_

- [x] 4.2 既存ルーティングファイルを保持する
  - 既存のルート定義を維持
  - 既存エンドポイントがデフォルトバージョン（v1）として動作するように設定
  - _Requirements: 1.2, 6.5_

- [ ] 4.3 ミドルウェアスタック統合を実施する
  - V1エンドポイントへの既存DynamicRateLimitミドルウェア適用を検証
  - V1エンドポイントへの既存SetRequestIdミドルウェア適用を検証
  - V1認証必須エンドポイントへのSanctum認証適用を検証
  - V1エンドポイントへのミドルウェアグループ設定継承を検証
  - エンドポイント分類別レート制限設定の適用を検証
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5_

- [x] 4.4 ルーティング統合テストを作成する
  - 全V1エンドポイントのルーティング動作を検証するテストを作成
  - ミドルウェアスタック統合を検証するテストを作成
  - _Requirements: 8.2_

---

## Phase 5: フロントエンド統合

- [x] 5. フロントエンド型定義を分離し、既存コンポーネントの動作を確認する
- [x] 5.1 V1型定義ファイルを作成する
  - V1 APIレスポンス型定義ファイルを新規作成
  - 全V1レスポンス型（Health, Login, User, Token, Error）を定義
  - 全V1リクエスト型（Login, RegisterUser）を定義
  - 型名にV1プレフィックスを付与
  - _Requirements: 7.1, 7.2, 7.3, 7.4_

- [x] 5.2 環境変数設定を追加する
  - APIバージョン指定用の環境変数を設定
  - APIベースURL設定を確認
  - APIクライアントのバージョン指定機能を実装
  - _Requirements: 7.5_

- [x] 5.3 既存コンポーネントの動作確認を実施する
  - admin-appの既存機能が正常動作することを確認
  - user-appの既存機能が正常動作することを確認
  - V1エンドポイントへのAPIリクエストが成功することを確認
  - _Requirements: 後方互換性の維持_

---

## Phase 6: E2Eテスト・CI/CD統合

- [ ] 6. E2Eテストを作成し、CI/CDパイプラインに統合する
- [ ] 6.1 E2Eテストを作成する
  - V1ヘルスチェックエンドポイントのE2Eテストを作成
  - V1ログインフローのE2Eテストを作成
  - V1トークン管理フローのE2Eテストを作成
  - V1エラーハンドリングのE2Eテストを作成
  - V1レート制限のE2Eテストを作成
  - レスポンスヘッダー検証のE2Eテストを作成
  - _Requirements: 8.4_

- [ ] 6.2 GitHub Actions paths設定を拡張する
  - V1コントローラーディレクトリをpaths設定に追加
  - ApiVersionミドルウェアをpaths設定に追加
  - V1ルーティングファイルをpaths設定に追加
  - V1 Presenter/Requestディレクトリをpaths設定に追加
  - フロントエンド型定義ファイルをpaths設定に追加
  - _Requirements: 9.1, 9.2_

- [ ] 6.3 テストカバレッジを検証する
  - 全テストスイート（Feature/Architecture/E2E）を実行
  - 85%以上のコードカバレッジを確認
  - CI/CD環境での全テスト成功を確認
  - _Requirements: 8.5, 8.6_

- [ ] 6.4 OpenAPI v1仕様を生成する
  - OpenAPI v1仕様生成コマンドを実装
  - 全V1エンドポイント定義を生成
  - リクエスト・レスポンススキーマを定義
  - 認証要件とレスポンスヘッダーを定義
  - Swagger UIでの動作確認を実施
  - _Requirements: 9.3, 9.4, 9.5_

---

## Phase 7: ドキュメント整備

- [ ] 7. 実装ガイドとV2ロードマップをドキュメント化する
- [ ] 7.1 V1実装ガイドを作成する
  - 設計思想（URLベースバージョニング採用理由、DDD統合方針）を記載
  - 実装パターン（ApiVersionミドルウェア、ルーティング分離、コントローラー配置）を記載
  - テスト戦略（Feature/Architecture/E2E Testsの実行方法）を記載
  - トラブルシューティング（よくある問題と解決策）を記載
  - コードサンプルと設定例を含める
  - _Requirements: 10.1, 10.3, 10.4, 10.5_

- [ ] 7.2 V2ロードマップを作成する
  - V2実装方針（V2導入のタイミング、段階的移行戦略）を記載
  - 段階的移行戦略（既存V1クライアントのサポート継続方針）を記載
  - V2技術要件（新しいレスポンス形式、エラーハンドリング改善案）を記載
  - V2テスト戦略（V1/V2並行稼働時のテスト手法）を記載
  - Deprecation/Sunset運用方針（V1廃止計画、クライアント移行期間）を記載
  - コードサンプルと設定例を含める
  - _Requirements: 10.2, 10.3, 10.4, 10.5_

---

## 要件カバレッジマトリックス

| 要件ID | 要件概要 | 対応タスク |
|--------|----------|-----------|
| Requirement 1 | URLベースAPIバージョニング基盤 | 1.1, 1.2, 4.2 |
| Requirement 2 | 既存コントローラーのV1移行 | 2.1-2.6 |
| Requirement 3 | DDD 4層構造との統合 | 3.1-3.4 |
| Requirement 4 | 既存ミドルウェアスタック統合 | 4.3 |
| Requirement 5 | ApiVersionミドルウェア実装 | 1.1, 1.2, 1.4 |
| Requirement 6 | ルーティング分離とV1ルート定義 | 1.3, 4.1-4.2, 4.4 |
| Requirement 7 | フロントエンド型定義分離 | 5.1-5.2 |
| Requirement 8 | 完全なテスト戦略 | 1.4, 2.1-2.5, 3.1-3.2, 3.4, 4.4, 6.1, 6.3 |
| Requirement 9 | CI/CD統合とOpenAPI仕様生成 | 6.2, 6.4 |
| Requirement 10 | ドキュメント整備 | 7.1-7.2 |

---

## 実装完了条件

### Phase 1完了条件
- [ ] `config/api.php` が作成され、デフォルトバージョンとサポート対象バージョンリストが定義されている
- [ ] `ApiVersion` ミドルウェアが実装され、バージョン判定・ヘッダー付与機能が動作している
- [ ] `RouteServiceProvider` がV1ルーティングファイルをロードしている
- [ ] ミドルウェアのFeature Testsが全て成功している

### Phase 2完了条件
- [ ] 全5コントローラーが `app/Http/Controllers/Api/V1/` に配置されている
- [ ] 全V1コントローラーが `App\Http\Controllers\Api\V1` 名前空間を使用している
- [ ] 全V1エンドポイントが既存レスポンス形式・HTTPステータスコード・ヘッダーを保持している
- [ ] 既存Feature Testsが全て成功している（回帰テスト）

### Phase 3完了条件
- [ ] V1 Presenterが `ddd/Infrastructure/Http/Presenters/V1/` に配置されている
- [ ] V1 Requestが `ddd/Infrastructure/Http/Requests/V1/` に配置されている
- [ ] Architecture Testsで依存方向違反ゼロが確認されている
- [ ] Domain/Application層がバージョン固有クラスに非依存であることが検証されている

### Phase 4完了条件
- [ ] `routes/api/v1.php` が全V1エンドポイントを定義している
- [ ] 既存 `/api/` エンドポイントがデフォルトバージョン（v1）として動作している
- [ ] V1エンドポイントに既存ミドルウェアスタックが適用されている
- [ ] ルーティング統合テストが全て成功している

### Phase 5完了条件
- [ ] `frontend/types/api/v1.ts` が全V1レスポンス型を定義している
- [ ] `NEXT_PUBLIC_API_VERSION=v1` 環境変数が設定されている
- [ ] admin-app/user-appが正常動作している

### Phase 6完了条件
- [ ] E2Eテスト `api-versioning.spec.ts` が全て成功している
- [ ] `.github/workflows/test.yml` のpaths設定にV1関連ファイルが追加されている
- [ ] CI/CD環境で全テストスイート（Feature/Architecture/E2E）が成功している
- [ ] 85%以上のコードカバレッジが維持されている
- [ ] `docs/openapi-v1.yaml` が生成され、Swagger UIで動作確認されている

### Phase 7完了条件
- [ ] `backend/laravel-api/docs/api-versioning-guide.md` が設計思想・実装パターン・テスト戦略・トラブルシューティングを含む
- [ ] `backend/laravel-api/docs/api-versioning-v2-roadmap.md` がV2実装方針・段階的移行戦略・技術要件・Deprecation運用方針を含む
- [ ] 全ドキュメントが日本語で記述され、コードサンプル・設定例を含む

---

## 実装時の注意事項

### DDD/クリーンアーキテクチャ準拠
- Domain層とApplication層はバージョン固有の依存関係を含めない
- V1固有のロジックはHTTP層（Controller）とInfrastructure層（Presenter/Request）に配置
- Architecture Testsで依存方向を継続的に検証

### 後方互換性の維持
- 既存のAPIエンドポイント（`/api/`）は維持し、デフォルトバージョン（v1）として動作させる
- 既存のレスポンス形式・HTTPステータスコード・ヘッダーを変更しない
- 既存のミドルウェアスタック（DynamicRateLimit、SetRequestId、Sanctum認証）を継承

### テスト戦略
- Feature Tests: 各V1エンドポイントの動作を検証
- Architecture Tests: Domain/Application層のバージョン非依存性を検証
- E2E Tests: V1エンドポイントのエンドツーエンドフローを検証
- 85%以上のコードカバレッジを維持

### パフォーマンス要件
- バージョニングによるオーバーヘッドを5ms未満に抑える
- 正規表現処理を1ms未満で完了させる

---

## ロールバック戦略

### Phase 1-2 ロールバック条件
- ApiVersionミドルウェアのFeature Testsが失敗
- 既存エンドポイントの回帰テストが失敗
- バージョニングオーバーヘッドが5msを超過

### Phase 3-4 ロールバック条件
- Architecture Testsで依存方向違反を検出
- V1エンドポイントのレスポンス形式が既存と異なる
- E2Eテストが失敗

### Phase 5-6 ロールバック条件
- フロントエンドアプリケーション（admin-app/user-app）の動作異常
- CI/CD環境でのテスト失敗
- OpenAPI仕様生成エラー

### Phase 7 ロールバック条件
- ドキュメントの重大な誤記や欠落
- V2ロードマップの実現不可能な計画

---

## 次のステップ

タスク承認後、以下のコマンドで実装を開始してください:

```bash
# 全タスクを順次実行
/kiro:spec-impl api-versioning

# 特定のタスクを実行
/kiro:spec-impl api-versioning 1.1

# 複数のタスクを実行
/kiro:spec-impl api-versioning 1,2,3
```

実装完了後、各タスクを完了としてマークしてください。
