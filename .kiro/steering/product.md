# Product Overview

## プロダクト概要
Laravel Next.js B2Cアプリケーションテンプレート - **API専用最適化Laravel 12** + Next.js 15.5のモノレポ構成で、モダンなB2Cビジネス向けの超高速開発テンプレート

### 🚀 パフォーマンス最適化済み
- **33.3%起動速度向上** (業界標準20-30%を上回る)
- **96.5%依存関係削減** (4コアパッケージ構成)
- **0.33KB/request** (画期的なメモリ効率)
- **ステートレス設計** (水平スケーリング対応)

## 主要機能
- **⚡ 一括セットアップスクリプト実装**: `make setup` コマンドによる15分以内の完全な開発環境構築
  - **前提条件チェック**: Docker、Node.js、PHP等のバージョン確認と推奨バージョン案内
  - **環境変数設定**: `.env`、`.env.local`の自動生成とAPP_KEY生成
  - **依存関係インストール**: Composer、npm、Dockerイメージの自動インストール
  - **サービス起動**: PostgreSQL、Redis、Mailpit、MinIO、Laravel API、User App、Admin Appの一括起動
  - **セットアップ検証**: 全サービスの疎通確認とヘルスチェック
  - **冪等性保証**: 何度実行しても安全、既存設定の保持
  - **エラーハンドリング**: わかりやすいエラーメッセージと解決策の提示
  - **部分的再実行**: `make setup-from STEP=...` による指定ステップからの再実行機能
- **🚀 統合開発サーバー起動スクリプト実装**: `make dev` コマンドによる全サービス統一起動（Phase 1-6完了、テスト95% Pass）
  - **3つの起動モード**: ハイブリッド（推奨）、Docker、ネイティブモードの柔軟な切り替え
  - **プロファイル別起動**: full、api、frontend、infra、minimalの用途別プロファイル対応
  - **設定駆動アーキテクチャ**: YAML設定ファイルによる宣言的サービス定義、保守性向上
  - **ネイティブプロセスPID管理**: 停止精度向上、確実なプロセス終了保証
  - **CLIインターフェース**: make経由とシェルスクリプト直接実行の両対応
  - **シャットダウン機能**: 全プロセス確実終了、Docker/ネイティブ統一インターフェース
  - **ヘルスチェック統合**: 全サービス起動待機、タイムアウト設定
  - **npm使用**: package.jsonベース依存管理（pnpm非推奨、Codex指摘対応済み）
  - **MinIOヘルスチェック対応**: mc readyコマンド追加、起動確認強化
- **最適化済みAPI専用Laravel**: 必要最小限4パッケージ構成による超高速起動
- **🏗️ DDD/クリーンアーキテクチャ実装**: 4層構造（Domain/Application/Infrastructure/HTTP）によるビジネスロジック分離、Repository Pattern採用、SOLID原則準拠
- **デュアルフロントエンド構成**: 管理者用ダッシュボードとユーザー向けアプリの分離
- **モダンな技術スタック**: Next.js 15.5 + React 19 + Laravel 12 + TypeScript
- **完全なDocker環境**: Docker Compose統合による全サービス一括起動、ヘルスチェック機能統合、プロジェクト固有イメージ命名による競合回避
- **📊 APIヘルスチェックエンドポイント**: `/api/health`による稼働監視、Dockerヘルスチェック統合、JSON応答形式、ルート名アクセス対応（`route('health')`）
- **🔐 Laravel Sanctum認証基盤**: ステートレストークン認証による水平スケーリング対応
  - **認証エンドポイント**: Login/Logout、パスワードリセット対応
  - **トークン管理**: 発行、一覧取得、取り消し、更新機能
  - **セキュリティ強化**: トークン有効期限設定、自動期限切れトークン削除（日次スケジュール実行）
  - **統合認証ガード**: Sanctum middleware統合、API保護機能
- **PostgreSQL接続最適化**: タイムアウト設定・環境別設定・信頼性向上（接続5秒、ステートメント30秒）
- **モダンテストフレームワーク**: Pest 4による包括的テストスイート（96.1%カバレッジ達成）、Architecture Testing統合
- **テストDB環境切り替え**: SQLite（高速開発）/PostgreSQL（本番同等）の柔軟な切り替え、並列テスト実行（4 Shard）、Makefileタスク統合
- **フロントエンドテスト環境**: Jest 29 + Testing Library 16完全実装（カバレッジ94.73%達成）
- **E2Eテスト環境**: Playwright 1.47.2 + Docker実行対応、Laravel Sanctum認証統合、Page Object Modelパターン採用
- **E2E CI/CD自動実行**: GitHub Actions統合完了、Pull Request時の自動E2Eテスト実行（4 Shard並列実行、約2分完了）
- **CI/CDパフォーマンス最適化**: Composerキャッシング、並列実行（concurrency設定）、タイムアウト最適化（60分→20分）
- **GitHub Actions発火最適化**: Concurrency設定による重複実行削減、Paths設定による担当領域明確化、API契約監視による整合性検証、実行頻度60-70%削減
- **固定ポート設定**: 開発環境ポート統一（User App: 13001、Admin App: 13002、API: 13000）による複数プロジェクト並行開発対応、Dockerfile APP_PORTデフォルト値最適化済み（80→13000）
- **Dockerヘルスチェック**: 全サービスのヘルスチェック機能統合、依存関係の自動管理、障害検知の早期化（IPv4明示対応）、Laravel API `/api/health`エンドポイント統合
- **詳細最適化ドキュメント**: 他プロジェクトへの移行ガイド完備、DDDアーキテクチャガイド・開発ガイド・テスト戦略ドキュメント統合、Dockerトラブルシューティング完全ガイド（DOCKER_TROUBLESHOOTING.md）
- **開発者エクスペリエンス**: Turbopack、Tailwind CSS v4、ESLintの統合開発環境
- **モノレポ統一コード品質管理**: ESLint 9 + Prettier設定、husky + lint-staged導入による自動品質チェック
- **フロントエンドテストコードESLint統合**: Jest + Testing Library + Jest-DOM専用ESLintルール適用（errorレベル）、テストコード品質の自動検証、4つの包括的ガイドドキュメント完備
- **PHP品質管理システム**: Laravel Pint + Larastan (PHPStan Level 8) + Pest 4 + Git Hooks + CI/CD統合による包括的コード品質保証
- **🌐 CORS環境変数ドリブン設定**: 環境変数による柔軟なCORS設定、開発/本番環境対応、セキュリティ強化、フロントエンドアプリとのシームレスな統合
- **🔐 包括的セキュリティヘッダー実装**: OWASP準拠のセキュリティベストプラクティス統合
  - **セキュリティヘッダー**: X-Frame-Options、X-Content-Type-Options、Referrer-Policy、CSP、Permissions-Policy、HSTS
  - **段階的CSP導入**: Report-Onlyモード（監視）→ Enforceモード（強制）の段階的移行戦略
  - **CSP違反レポート収集**: Laravel/Next.js両対応、違反検出・分析による最適化、application/json互換性対応
  - **環境変数駆動設定**: 開発/本番環境で異なるセキュリティレベル適用、柔軟なポリシーカスタマイズ
  - **自動CI/CD検証**: GitHub Actionsによるセキュリティヘッダー自動検証、検証スクリプト統合
  - **包括的ドキュメント**: 実装ガイド、運用マニュアル、トラブルシューティング完備
- **🛡️ 基本ミドルウェアスタック実装完了**: 統一ミドルウェアスタックによる包括的API保護（Phase 1-7完了、145テスト成功、85%カバレッジ達成）
  - **ログ・監視**: 構造化ログ（SetRequestId）、パフォーマンス監視、セキュリティログ分離、個人情報配慮対応（環境変数でハッシュ化制御）
  - **APIレート制限強化**:
    - **エンドポイント分類細分化**: 認証API（5回/分）、書き込みAPI（10回/分）、読み取りAPI（60回/分）、管理者API（100回/分）
    - **Redis障害時フェイルオーバー**: キャッシュストア環境変数対応（Redis/Array自動切替）、`RATELIMIT_CACHE_STORE`設定
    - **キャッシュ競合対策**: `Cache::increment()` + `Cache::add()`組み合わせによるアトミック操作
    - **動的制限値設定**: エンドポイント別レート制限、環境変数駆動設定、retry_after負の値問題修正
    - **DDD準拠実装**: Application層にRateLimitConfig配置、ドメインロジック分離
    - **包括的テストカバレッジ**: 145テスト成功、Architecture Tests統合、環境変数駆動テスト
  - **Idempotency**: 冪等性保証、24時間キャッシュ、Webhook対応、キャッシュストア環境変数対応（`IDEMPOTENCY_CACHE_STORE`）
  - **認証・認可**: Laravel Sanctum統合、複数認証ガード対応
  - **監査ログ**: ユーザー行動追跡、イベントログ記録
  - **キャッシュ管理**: ETags、HTTP Cache-Control、条件付きリクエスト対応
  - **DDD統合**: ミドルウェア設定のApplication層配置、Repositoryパターン採用、イベント駆動設計

## ターゲットユースケース
- **B2Cアプリケーション開発**: EC、SaaS、メディアサイトなどの顧客向けサービス
- **管理ダッシュボード付きサービス**: コンテンツ管理、ユーザー管理、データ分析が必要なプラットフォーム
- **API駆動型アプリケーション**: モバイルアプリや外部システム連携を想定したサービス
- **プロトタイプ開発**: MVPや概念実証での迅速な開発開始
- **チーム開発**: フロントエンドとバックエンドの分離による並行開発

## 主要な価値提案
- **画期的なパフォーマンス**: 業界標準を上回る33.3%の起動速度向上とメモリ効率最適化
- **開発者エクスペリエンスの最大化**: 2コマンドで完全な開発環境構築（`git clone` + `make setup`）、15分以内で即座にコーディング開始可能
  - **初回セットアップ**: 前提条件チェック機能によるセットアップ失敗の事前防止、エラー時の部分的再実行機能
  - **日常開発フロー**: `make dev`単一コマンドで全サービス起動、3つの起動モード（ハイブリッド/Docker/ネイティブ）選択可能
  - **柔軟な開発環境**: 用途別プロファイル対応（API専用、フロントエンド専用等）、設定駆動アーキテクチャによる保守性向上
  - **確実な停止機能**: `make dev-stop`でDocker/ネイティブプロセス統一的に停止、ネイティブプロセスPID管理による確実終了
  - **冪等性保証**: 何度実行しても安全な再実行と既存設定の保持
- **実証済みの最適化**: 定量的パフォーマンス測定と包括的ドキュメント化による信頼性
- **保守性の確保**: 明確な分離アーキテクチャと最小依存関係による長期的な拡張性
- **本番環境対応の信頼性**: Dockerヘルスチェック統合によるサービス起動保証、依存関係の自動管理、障害検知の早期化、APIヘルスチェックエンドポイントによる稼働監視
- **現代的な開発手法**: TypeScript、包括的テスト環境、リンター等のベストプラクティス導入済み
- **チーム開発の効率化**: API専用設計と固定ポート設定による役割分担と並行開発の最適化
- **本番環境対応**: Dockerベースの構成とステートレス設計による環境差異の最小化
- **移行容易性**: 詳細ドキュメントによる他プロジェクトへの最適化手法適用可能
- **品質管理の自動化**: Git Hooks + CI/CDによる自動品質チェック、人的エラー削減
- **完全なテスト戦略**: ユニット（Jest/Pest）→統合（Testing Library）→E2E（Playwright + Docker）の3層テスト体制、テストDB環境管理（SQLite/PostgreSQL切り替え、並列実行）
- **高速CI/CDパイプライン**: Composerキャッシング、並列実行最適化、タイムアウト短縮による開発効率向上
- **インテリジェントCI/CD**: Paths設定による必要最小限のワークフロー実行、Concurrencyによる重複実行自動キャンセル、API契約変更の早期検出
- **本番環境セキュリティ対応**: OWASP準拠セキュリティヘッダー実装、XSS/CSRF/クリックジャッキング攻撃防御、段階的CSP導入による既存機能への影響最小化、環境変数駆動設定による柔軟なポリシー管理
- **包括的API保護完了**: 基本ミドルウェアスタック統合による6層防御（ログ・監視、APIレート制限強化、冪等性保証、認証・認可、監査ログ、キャッシュ管理）、環境変数駆動設定による柔軟な運用、Redis障害時フェイルオーバー対応、DDD Application層統合によるアーキテクチャ整合性保証、85%以上のテストカバレッジ達成

## アーキテクチャ上の特徴
- **API専用最適化**: Web機能削除によるステートレス設計とパフォーマンス最大化
- **🏗️ DDD/クリーンアーキテクチャ**:
  - **4層構造**: Domain層（ビジネスロジック）、Application層（ユースケース）、Infrastructure層（外部システム）、HTTP層（インターフェース）
  - **依存性逆転原則**: Domain層を中心とした依存方向の制御、フレームワーク非依存設計
  - **Repository Pattern**: データアクセスの抽象化、テスタビリティの向上
  - **SOLID原則準拠**: 単一責任、オープン・クローズド、リスコフの置換、インターフェース分離、依存性逆転
  - **Architecture Testing**: Pestによる依存方向とレイヤー分離の自動検証
- **最小依存関係**: Laravel 12 + Sanctum + Tinker + Pintの4コアパッケージ構成
- **フロントエンド分離**: 管理者とユーザーの異なるUIニーズに対応
- **🔐 Laravel Sanctumトークンベース認証**:
  - **ステートレス設計**: セッション不使用、水平スケーリング対応
  - **Personal Access Tokens**: UUIDベーストークン、有効期限管理
  - **認証エンドポイント**: `/api/login`, `/api/logout`, `/api/me`, `/api/tokens/*`
  - **トークンライフサイクル管理**: 自動期限切れ削除（Scheduled Tasks統合）、手動取り消し機能
  - **セキュリティベストプラクティス**: `auth:sanctum` middleware、CSRF保護、レート制限対応
  - **PHPStan Level 8準拠**: 型安全性保証、静的解析合格
- **🌐 CORS環境変数ドリブン設定**:
  - **環境変数による柔軟な設定**: `CORS_ALLOWED_ORIGINS` 環境変数で動的設定
  - **開発/本番環境対応**: 環境別のオリジン設定（localhost:13001,13002 → 本番ドメイン）
  - **セキュリティ強化**: ワイルドカード禁止、明示的オリジン指定、本番環境での厳格な検証
  - **テスト環境統合**: PHPUnit/Pest テストでのCORS検証サポート
  - **完全ガイド**: `docs/CORS_CONFIGURATION_GUIDE.md` による環境別設定・トラブルシューティング
- **CORS最適化**: Next.js フロントエンドとの完全統合設定
- **モジュラー構成**: 各コンポーネントの独立開発・デプロイ可能、既存MVCとDDD層の共存戦略
- **包括的最適化ドキュメント**: `backend/laravel-api/docs/`に移行ガイド・DDDアーキテクチャガイド完備
- **開発環境統一**: Docker Compose統合による全サービス一括起動・一貫した環境構築、プロジェクト固有Dockerイメージ命名（laravel-next-b2c/app）による他プロジェクトとの競合回避
- **Dockerヘルスチェック統合**: 全サービス（Laravel API、Next.js apps、PostgreSQL、Redis）のヘルスチェック機能、`docker compose ps`によるリアルタイム状態確認、IPv4明示対応（localhost→127.0.0.1）、Laravel API `/api/health`エンドポイント統合（動的ポート対応）
- **PostgreSQL接続最適化**: ServiceProvider方式によるタイムアウト設定、環境別設定テンプレート（Docker/Native/Production）、エラーハンドリング強化
- **固定ポート設計**: 13000番台統一によるポート競合回避、複数プロジェクト同時実行対応、Dockerfileデフォルト値最適化（APP_PORT=13000）、ランタイム変更可能（再ビルド不要）
- **Next.js最適化構成**: outputFileTracingRoot設定によるDocker Standalone最適化
- **🔐 セキュリティヘッダー統合**:
  - **OWASP準拠実装**: XSS、CSRF、クリックジャッキング、MIMEスニッフィング攻撃防御
  - **Laravel API**: 動的CSP構築、CORS統合、CSP違反レポート収集（application/json対応）
  - **Next.js Apps**: 環境変数駆動設定、User App（柔軟設定）/Admin App（厳格設定）の適切な分離
  - **段階的導入戦略**: Report-Onlyモード運用 → 違反分析・ポリシー調整 → Enforceモード切り替え
  - **CI/CD検証**: セキュリティヘッダー自動検証ワークフロー、検証スクリプト統合（Laravel/Next.js対応）
- **🛡️ 基本ミドルウェアスタック完全実装**:
  - **統一ミドルウェアスタック**: ログ・監視、APIレート制限強化、冪等性保証、認証・認可、監査ログ、キャッシュ管理の6層構成
  - **APIレート制限強化詳細**:
    - **エンドポイント分類**: 認証API（5回/分）、書き込みAPI（10回/分）、読み取みAPI（60回/分）、管理者API（100回/分）
    - **Redis障害時フェイルオーバー**: `RATELIMIT_CACHE_STORE`環境変数によるRedis/Array自動切替
    - **キャッシュ競合対策**: アトミック操作による同時リクエスト対応（`Cache::increment()` + `Cache::add()`）
    - **動的制限値設定**: 環境変数駆動によるエンドポイント別レート制限カスタマイズ
    - **retry_after最適化**: 負の値問題修正、resetAt計算改善
  - **環境変数駆動設定**: Redis/Arrayキャッシュストア切替、エンドポイント別レート制限設定、個人情報ハッシュ化制御
  - **Laravel標準実装**: SetRequestIdでramsey/uuid依存排除、Laravel標準Str::uuid()使用
  - **DDD Application層統合**: ミドルウェア設定をApplication層に配置（RateLimitConfig）、Repositoryパターン採用、イベント駆動設計
  - **包括的テストカバレッジ**: 145テスト成功、85%カバレッジ達成、環境変数駆動テスト、キャッシュストア切替テスト、Architecture Tests統合

## 最適化実績
### パフォーマンス改善メトリクス
| 項目 | 改善前 | 改善後 | 改善率 |
|------|--------|--------|---------|
| **起動速度** | ベースライン | 33.3ms | **33.3%向上** |
| **メモリ効率** | 30.8MB | 0.33KB/request | **画期的改善** |
| **依存関係** | 114パッケージ | 4コア | **96.5%削減** |
| **レスポンス** | - | 11.8ms | **<20ms達成** |

### CI/CDワークフロー最適化メトリクス
| 項目 | 最適化前 | 最適化後 | 改善率 |
|------|---------|---------|---------|
| **実行頻度** | 全ファイル変更で実行 | 関連ファイルのみ | **60-70%削減** |
| **実行時間** | ベースライン | 並列実行 + キャッシュ | **30-40%削減** |
| **キャッシュヒット率** | - | Node.js/Composer | **80%以上** |
| **API契約整合性** | 検出なし | 自動検出 | **早期検出** |