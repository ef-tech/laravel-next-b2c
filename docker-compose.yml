# ============================================
# Laravel + Next.js モノレポ Docker Compose設定
# ============================================
# 使用方法:
#   make dev    - Laravel API + Infra起動
#   make stop   - すべてのサービス停止
#   make clean  - コンテナ・ボリューム削除
# ============================================
# Git Worktree並列開発対応:
#   - COMPOSE_PROJECT_NAME: wt${WORKTREE_ID} (例: wt0, wt1, wt2...)
#   - コンテナ名: ${COMPOSE_PROJECT_NAME}-laravel-api, ${COMPOSE_PROJECT_NAME}-pgsql等
#   - ネットワーク名: ${COMPOSE_PROJECT_NAME}-network
#   - ボリューム名: ${COMPOSE_PROJECT_NAME}-pgsql, ${COMPOSE_PROJECT_NAME}-redis等
#   - DB_DATABASE: laravel_wt${WORKTREE_ID}
#   - CACHE_PREFIX: wt${WORKTREE_ID}_
# ============================================

services:
  # ============================================
  # Laravel API サービス
  # ============================================
  laravel-api:
    build:
      context: ./backend/laravel-api/docker/8.4
      dockerfile: Dockerfile
      args:
        WWWGROUP: '${WWWGROUP:-1000}'
    image: laravel-next-b2c/app
    container_name: '${COMPOSE_PROJECT_NAME:-laravel-next-b2c}-laravel-api'
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    ports:
      - '${APP_PORT:-13000}:${APP_PORT:-13000}'
    environment:
      WWWUSER: '${WWWUSER:-1000}'
      APP_PORT: '${APP_PORT:-13000}'
      APP_ENV: local  # ホットリロード有効化
      LARAVEL_SAIL: 1
      XDEBUG_MODE: '${SAIL_XDEBUG_MODE:-off}'
      XDEBUG_CONFIG: '${SAIL_XDEBUG_CONFIG:-client_host=host.docker.internal}'
      IGNITION_LOCAL_SITES_PATH: '${PWD}/backend/laravel-api'
      # Git Worktree並列開発対応: DB名とキャッシュプレフィックスを動的設定
      DB_DATABASE: '${DB_DATABASE:-laravel}'
      CACHE_PREFIX: '${CACHE_PREFIX:-}'
    volumes:
      # ソースコードのvolume mount（:cachedでパフォーマンス向上）
      - './backend/laravel-api:/var/www/html:cached'
    networks:
      - 'app-network'
    depends_on:
      - pgsql
      - redis
      - mailpit
      - minio
    working_dir: /var/www/html
    healthcheck:
      test:
        - CMD
        - sh
        - -c
        - 'wget --no-verbose --tries=1 --spider http://127.0.0.1:$${APP_PORT:-13000}/api/health || exit 1'
      interval: 10s
      timeout: 3s
      start_period: 30s
      retries: 3
    profiles:
      - api

  # ============================================
  # Next.js Apps (admin-app, user-app)
  # ============================================
  # Next.jsアプリはネイティブ起動を推奨（Turbopack最高速パフォーマンス）
  #
  # ネイティブ起動方法:
  #   Terminal 2: cd frontend/admin-app && npm run dev  # ポート: 13002
  #   Terminal 3: cd frontend/user-app && npm run dev   # ポート: 13001
  # ============================================

  # ============================================
  # E2E Tests (Playwright)
  # ============================================
  e2e-tests:
    image: mcr.microsoft.com/playwright:v1.47.2-jammy
    container_name: '${COMPOSE_PROJECT_NAME:-laravel-next-b2c}-e2e-tests'
    working_dir: /app
    environment:
      # Next.jsアプリはネイティブ起動のため、localhostでアクセス
      E2E_ADMIN_URL: '${E2E_ADMIN_URL:-http://localhost:13200}'
      E2E_USER_URL: '${E2E_USER_URL:-http://localhost:13100}'
      E2E_API_URL: '${E2E_API_URL:-http://localhost:13000}'
      E2E_ADMIN_EMAIL: '${E2E_ADMIN_EMAIL:-admin@example.com}'
      E2E_ADMIN_PASSWORD: '${E2E_ADMIN_PASSWORD:-password}'
      E2E_USER_EMAIL: '${E2E_USER_EMAIL:-user@example.com}'
      E2E_USER_PASSWORD: '${E2E_USER_PASSWORD:-password}'
    volumes:
      - './e2e:/app'
    networks:
      - 'app-network'
    depends_on:
      # Next.jsアプリはネイティブ起動のため、Laravel APIのみに依存
      laravel-api:
        condition: service_healthy
    shm_size: '1gb'
    command: >
      sh -c "
        npm install &&
        npx playwright install --with-deps &&
        npm run test:ci
      "
    profiles:
      - e2e

  # ============================================
  # PostgreSQL 17
  # ============================================
  # Git Worktree並列開発対応: 内部ネットワーク専用（ポート衝突なし）
  # - ホストから直接接続不可（内部サービスからのみアクセス可能）
  # - デフォルトポート5432使用
  # - 必要に応じて `docker compose exec pgsql psql` でアクセス
  pgsql:
    image: 'postgres:17-alpine'
    container_name: '${COMPOSE_PROJECT_NAME:-laravel-next-b2c}-pgsql'
    # ports削除: 内部ネットワーク専用（ホスト公開なし）
    environment:
      PGPASSWORD: '${DB_PASSWORD:-secret}'
      POSTGRES_DB: '${DB_DATABASE:-laravel}'
      POSTGRES_USER: '${DB_USERNAME:-sail}'
      POSTGRES_PASSWORD: '${DB_PASSWORD:-secret}'
    volumes:
      - 'pgsql:/var/lib/postgresql/data'
      - './backend/laravel-api/vendor/laravel/sail/database/pgsql/create-testing-database.sql:/docker-entrypoint-initdb.d/10-create-testing-database.sql'
      - './backend/laravel-api/docker/pgsql/init.d/create-database.sh:/docker-entrypoint-initdb.d/20-create-database.sh'
    networks:
      - 'app-network'
    healthcheck:
      test:
        - CMD
        - pg_isready
        - '-q'
        - '-d'
        - '${DB_DATABASE:-laravel}'
        - '-U'
        - '${DB_USERNAME:-sail}'
      retries: 3
      timeout: 5s
    profiles:
      - infra

  # ============================================
  # Redis
  # ============================================
  # Git Worktree並列開発対応: 内部ネットワーク専用（ポート衝突なし）
  # - ホストから直接接続不可（内部サービスからのみアクセス可能）
  # - デフォルトポート6379使用
  # - 必要に応じて `docker compose exec redis redis-cli` でアクセス
  redis:
    image: 'redis:alpine'
    container_name: '${COMPOSE_PROJECT_NAME:-laravel-next-b2c}-redis'
    # ports削除: 内部ネットワーク専用（ホスト公開なし）
    volumes:
      - 'redis:/data'
    networks:
      - 'app-network'
    healthcheck:
      test:
        - CMD
        - redis-cli
        - ping
      retries: 3
      timeout: 5s
    profiles:
      - infra

  # ============================================
  # Mailpit (開発用メールサーバー)
  # ============================================
  # Git Worktree並列開発対応: 外部ポートのみ動的、内部ポートはデフォルト値
  # - 内部ポート: 1025 (SMTP), 8025 (UI) - デフォルト値固定
  # - 外部ポート: ${FORWARD_MAILPIT_PORT} (SMTP), ${FORWARD_MAILPIT_DASHBOARD_PORT} (UI) - 環境変数で変更可能
  mailpit:
    image: 'axllent/mailpit:latest'
    container_name: '${COMPOSE_PROJECT_NAME:-laravel-next-b2c}-mailpit'
    ports:
      - '${FORWARD_MAILPIT_PORT:-14300}:1025'              # 内部1025 → 外部14300
      - '${FORWARD_MAILPIT_DASHBOARD_PORT:-14200}:8025'    # 内部8025 → 外部14200
    environment:
      MP_SMTP_BIND_ADDR: ':1025'      # デフォルト値
      MP_UI_BIND_ADDR: ':8025'        # デフォルト値
    networks:
      - 'app-network'
    profiles:
      - infra

  # ============================================
  # MinIO (S3互換オブジェクトストレージ)
  # ============================================
  # Git Worktree並列開発対応: 外部ポートのみ動的、内部ポートはデフォルト値
  # - 内部ポート: 9000 (API), 9001 (Console) - デフォルト値固定
  # - 外部ポート: ${FORWARD_MINIO_PORT} (API), ${FORWARD_MINIO_CONSOLE_PORT} (Console) - 環境変数で変更可能
  minio:
    image: 'minio/minio:latest'
    container_name: '${COMPOSE_PROJECT_NAME:-laravel-next-b2c}-minio'
    ports:
      - '${FORWARD_MINIO_PORT:-14400}:9000'           # 内部9000 → 外部14400
      - '${FORWARD_MINIO_CONSOLE_PORT:-13300}:9001'   # 内部9001 → 外部13300
    environment:
      MINIO_ROOT_USER: sail
      MINIO_ROOT_PASSWORD: password
    volumes:
      - 'minio:/data'
    networks:
      - 'app-network'
    command: 'minio server /data --console-address ":9001"'  # デフォルト値
    healthcheck:
      test:
        - CMD
        - sh
        - -c
        - 'wget --no-verbose --tries=1 --spider http://127.0.0.1:9000/minio/health/live || exit 1'  # 内部ポート使用
      interval: 10s
      retries: 3
      timeout: 5s
    profiles:
      - infra

# ============================================
# ネットワーク設定
# ============================================
# Git Worktree並列開発対応: ネットワーク名を動的に設定
# 例: wt0-network, wt1-network, wt2-network...
networks:
  app-network:
    name: '${COMPOSE_PROJECT_NAME:-laravel-next-b2c}-network'
    driver: bridge

# ============================================
# ボリューム設定
# ============================================
# Git Worktree並列開発対応: ボリューム名を動的に設定
# 例: wt0-pgsql, wt1-pgsql, wt2-pgsql...
volumes:
  pgsql:
    name: '${COMPOSE_PROJECT_NAME:-laravel-next-b2c}-pgsql'
    driver: local
  redis:
    name: '${COMPOSE_PROJECT_NAME:-laravel-next-b2c}-redis'
    driver: local
  minio:
    name: '${COMPOSE_PROJECT_NAME:-laravel-next-b2c}-minio'
    driver: local
